<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <link rel="canonical" href="https://soundbox.altwaves.co.jp/">
    <meta name="description" content="Soundbox Engine v6.1 (Rev 18.0): Sabine-Eyring Hybrid Professional System with Real-time Measurement">
    <title>Soundbox Material Calculator v7 | ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«èª¿éŸ³è¨­è¨ˆãƒ„ãƒ¼ãƒ«</title>

```
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root { 
        --primary: #39d353; 
        --bg: #0d1117; 
        --card: #161b22; 
        --text: #e6edf3; 
        --dim: #8b949e; 
        --border: #30363d; 
        --accent: #388bfd; 
        --danger: #ff7b72; 
        --warning: #d29922; 
        --success: #39d353; 
        --caution: #f0883e;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); padding: 15px; margin: 0; font-size: 13px; line-height: 1.4; }
    .container { max-width: 1000px; min-width: 800px; margin: auto; background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.5); position: relative; }
    .header { border-bottom: 1px solid var(--border); margin-bottom: 20px; padding-bottom: 12px; position: relative; }
    .header-top { display: flex; justify-content: space-between; align-items: flex-start; }
    h2 { color: var(--primary); margin: 0; font-size: 1.4rem; letter-spacing: 0.5px; }
    .subtitle { font-size: 0.85rem; color: var(--text); margin-top: 5px; font-weight: 500; }
    .logic-note { position: absolute; bottom: 8px; right: 0; font-size: 0.65rem; color: var(--dim); font-style: italic; }
    .btn-group { display: flex; gap: 10px; }
    .btn-base { border: none; padding: 7px 16px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: bold; transition: opacity 0.2s; text-decoration: none; }
    .btn-print { background: var(--border); color: var(--text); border: 1px solid var(--border); }
    .btn-estimate { background: var(--accent); color: white; }
    .btn-base:hover { opacity: 0.8; }
    .section-title { font-size: 0.8rem; font-weight: bold; color: var(--accent); margin: 20px 0 10px 0; border-left: 3px solid var(--accent); padding-left: 8px; }
    input, select, .custom-select-trigger { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0 10px; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 0.75rem; height: 36px; line-height: 34px; display: flex; align-items: center; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
    .grid-row { display: grid; grid-template-columns: 2fr 3.5fr 0.8fr 0.8fr 1fr; gap: 8px; margin-bottom: 8px; align-items: end; }
    label { font-size: 0.65rem; color: var(--dim); margin-bottom: 4px; display: block; }
    .custom-select-container { position: relative; width: 100%; }
    .custom-select-trigger { cursor: pointer; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; border: 1px solid var(--border); }
    .sub-panel { display: none; position: absolute; top: 100%; left: 0; width: 540px; background: #1c2128; border: 1px solid var(--accent); border-radius: 8px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.8); padding: 15px; margin-top: 5px; }
    .sub-panel.active { display: block; }
    .panel-cols { display: grid; grid-template-columns: 1.4fr 0.8fr 1.2fr; gap: 12px; }
    .col-title { font-size: 0.6rem; color: var(--accent); margin-bottom: 8px; font-weight: bold; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
    .col-item { padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-bottom: 3px; font-size: 0.7rem; color: var(--text); }
    .col-item:hover { background: var(--border); }
    .col-item.selected { background: var(--accent); color: white; font-weight: bold; }
    .res-panel { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
    .res-card { background: var(--bg); padding: 15px; border-radius: 10px; border: 2px solid var(--border); text-align: center; }
    .res-val { font-size: 1.6rem; font-weight: bold; font-family: "Roboto Mono", monospace; }
    .chart-wrapper { position: relative; height: 320px; margin-top: 10px; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: rgba(0,0,0,0.2); }
    .footer-note { margin-top: 20px; padding: 18px; background: rgba(56, 139, 253, 0.05); border-radius: 8px; border: 1px solid var(--border); }
    .advice-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-weight: bold; margin-bottom: 8px; font-size: 0.7rem; color: #000; }
    #print-only-notice { display: none; margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.75rem; line-height: 1.6; color: #333; }
    .mode-switcher { display: flex; background: var(--bg); padding: 4px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
    .mode-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--dim); cursor: pointer; border-radius: 6px; font-weight: bold; transition: 0.2s; font-size: 0.75rem; }
    .mode-btn.active { background: var(--accent); color: white; }
    .mode-btn.active.measure { background: var(--warning); color: #000; }
    .calc-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 0.6rem; font-weight: bold; margin-left: 5px; background: var(--accent); color: white; }
    .measurement-panel { background: rgba(56, 139, 253, 0.05); border: 1px solid var(--accent); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    .measure-controls { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end; }
    .status-msg { font-size: 0.75rem; margin-top: 10px; font-weight: 500; min-height: 1.2em; padding: 8px; border-radius: 4px; text-align: center; }
    .status-msg.ready { color: var(--dim); }
    .status-msg.calibrating { background: rgba(210, 153, 34, 0.1); color: var(--warning); }
    .status-msg.analyzing { background: rgba(56, 139, 253, 0.1); color: var(--accent); }
    .status-msg.success { background: rgba(57, 211, 83, 0.1); color: var(--success); }
    .status-msg.error { background: rgba(255, 123, 114, 0.1); color: var(--danger); }

    /* ========================================
       æ¸¬å®šé€²æ—ãƒãƒ¼ï¼ˆRev 18.0 æ–°è¦è¿½åŠ ï¼‰
       ======================================== */
    .measure-progress {
        margin-top: 10px;
        padding: 10px 12px;
        background: rgba(0,0,0,0.2);
        border-radius: 6px;
        border: 1px solid var(--border);
    }
    .measure-progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }
    .measure-progress-label {
        font-size: 0.72rem;
        color: var(--text);
        font-weight: 500;
    }
    .measure-progress-count {
        font-size: 0.65rem;
        color: var(--dim);
        font-family: "Roboto Mono", monospace;
    }
    .measure-progress-bar-track {
        width: 100%;
        height: 8px;
        background: var(--border);
        border-radius: 4px;
        overflow: hidden;
    }
    .measure-progress-bar-fill {
        height: 100%;
        width: 0%;
        background: var(--accent);
        border-radius: 4px;
        transition: width 0.4s ease;
    }
    .measure-progress-time {
        font-size: 0.65rem;
        color: var(--dim);
        margin-top: 5px;
        text-align: right;
    }
    /* ======================================== */

    .recording-flash { display: none; background: rgba(255, 123, 114, 0.1); border: 2px solid var(--danger); border-radius: 8px; padding: 15px; margin-top: 10px; text-align: center; }
    .recording-flash.active { display: block; animation: flash-border 1s infinite; }
    .flash-icon { font-size: 2rem; animation: blink 1s infinite; }
    .flash-text { font-size: 0.9rem; font-weight: bold; color: var(--danger); margin-top: 8px; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    @keyframes flash-border { 0%, 100% { border-color: var(--danger); } 50% { border-color: rgba(255, 123, 114, 0.3); } }
    .snr-indicator { margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; }
    .snr-bar { position: relative; width: 100%; height: 20px; background: var(--border); border-radius: 10px; overflow: hidden; margin-top: 5px; }
    .snr-value { height: 100%; background: linear-gradient(90deg, var(--danger), var(--warning), var(--success)); transition: width 0.3s; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 0.7rem; font-weight: bold; color: white; }
    .warning-box { background: rgba(255, 123, 114, 0.1); border: 1px solid var(--danger); border-radius: 6px; padding: 12px; margin-top: 10px; font-size: 0.75rem; }
    .warning-box button { margin-top: 8px; padding: 6px 12px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-weight: bold; }
    .warning-box button:hover { opacity: 0.8; }
    #warning-reason { margin-top: 5px; font-size: 0.7rem; color: var(--dim); }

    @media print {
        @page { size: A4; margin: 15mm; }
        body { background: white !important; color: black !important; padding: 0; }
        .container { box-shadow: none !important; border: none !important; width: 100% !important; max-width: none !important; min-width: 0 !important; background: white !important; padding: 0 !important; }
        .no-print, .logic-note, .mode-switcher, .measurement-panel { display: none !important; }
        .header { border-bottom: 2pt solid black !important; }
        h2, .section-title, .res-val, .subtitle { color: black !important; }
        input, select, .custom-select-trigger { border: none !important; background: transparent !important; color: black !important; padding: 0 !important; height: auto !important; appearance: none; }
        .grid-row { border-bottom: 0.5pt solid #eee; padding-bottom: 5px; }
        .res-card { border: 1pt solid black !important; background: white !important; }
        .chart-wrapper { border: 1pt solid #ccc !important; background: white !important; height: 300px !important; }
        .footer-note { border: 1pt solid #ccc !important; background: #f9f9f9 !important; color: black !important; }
        #print-only-notice { display: block !important; border: none !important; }
    }
</style>
```

</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-top">
            <h2>Soundbox Material Calculator</h2>
            <div class="btn-group no-print">
                <button class="btn-base btn-print" onclick="prepareForPrint()">çµæœã‚’å°åˆ· / PDFä¿å­˜</button>
                <button class="btn-base btn-estimate" onclick="sendToGoogleForm()">ã“ã®å†…å®¹ã§è¦‹ç©ã‚‚ã‚Šä¾é ¼</button>
            </div>
        </div>
        <div class="subtitle">Soundbox Engine v6.1 (Rev 18.0): Sabine-Eyring Hybrid System with Real-time Measurement</div>
        <div class="logic-note">Hybrid Calculation Engine Active</div>
    </div>

```
<div class="mode-switcher no-print">
    <button class="mode-btn active" id="btnSim" onclick="setMode('sim')">è¨­è¨ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (Sabine)</button>
    <button class="mode-btn" id="btnMeasure" onclick="setMode('measure')">å®Ÿæ¸¬å€¤ãƒ™ãƒ¼ã‚¹æ”¹å–„ (Eyring)</button>
</div>

<div id="measurementPanel" class="measurement-panel no-print" style="display:none;">
    <div style="font-size:0.8rem; font-weight:bold; color:var(--accent); margin-bottom:12px;">
        ğŸ¤ PRO æ¸¬å®šãƒ¢ãƒ¼ãƒ‰ (Eyring Method / Log-Sweep Analysis)
    </div>
    
    <div class="measure-controls">
        <div>
            <label>å…¥åŠ›ãƒ‡ãƒã‚¤ã‚¹ (ãƒã‚¤ã‚¯)</label>
            <select id="micSelect">
                <option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>
            </select>
        </div>
        <div>
            <label>å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹ (ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼)</label>
            <select id="spkSelect">
                <option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>
            </select>
        </div>
        <button class="btn-base btn-estimate" id="startMeasBtn" onclick="runMeasurementSequence()">
            æ¸¬å®šé–‹å§‹
        </button>
    </div>
    
    <div id="measureStatus" class="status-msg ready">Ready - ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠã—ã¦æ¸¬å®šé–‹å§‹ã—ã¦ãã ã•ã„</div>

    <!-- ========================================
         æ¸¬å®šé€²æ—ãƒãƒ¼ï¼ˆRev 18.0 æ–°è¦è¿½åŠ ï¼‰
         #measureStatus ã®ç›´ä¸‹ã«é…ç½®
         ======================================== -->
    <div id="measureProgress" class="measure-progress" style="display:none;">
        <div class="measure-progress-header">
            <span id="progressLabel" class="measure-progress-label">æº–å‚™ä¸­...</span>
            <span id="progressCount" class="measure-progress-count">0 / 18</span>
        </div>
        <div class="measure-progress-bar-track">
            <div id="progressBar" class="measure-progress-bar-fill"></div>
        </div>
        <div id="progressTime" class="measure-progress-time">æ®‹ã‚Šç´„ 72 ç§’</div>
    </div>
    <!-- ======================================== -->
    
    <div id="snrIndicator" class="snr-indicator" style="display:none;">
        <label style="font-size:0.7rem; color:var(--dim);">ä¿¡å·å¯¾é›‘éŸ³æ¯” (S/N Ratio)</label>
        <div class="snr-bar">
            <div id="snrValue" class="snr-value" style="width:0%;"></div>
        </div>
    </div>
    
    <div id="recordingAlert" class="recording-flash">
        <div class="flash-icon">ğŸ”´</div>
        <div class="flash-text">ğŸ“¢ æ¸¬å®šä¸­ã§ã™ - é™ã‹ã«ã—ã¦ãã ã•ã„</div>
    </div>
    
    <div id="remeasureWarning" class="warning-box" style="display:none;">
        <strong>âš ï¸ ãƒ‡ãƒ¼ã‚¿å“è³ªãŒä¸è¶³ã—ã¦ã„ã¾ã™</strong>
        <div id="warningReason"></div>
        <button onclick="runMeasurementSequence()">å†æ¸¬å®šã‚’å®Ÿè¡Œ</button>
    </div>
    
    <div id="manualInputPanel" style="display:none; margin-top:15px; padding:12px; background:rgba(0,0,0,0.2); border-radius:6px;">
        <label style="font-size:0.7rem; color:var(--warning); font-weight:bold;">
            æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¸¬å®šå€¤ã‚’ç›´æ¥å…¥åŠ›ï¼‰
        </label>
        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-top: 8px;">
            <div><label>125Hz</label><input type="number" id="m125" value="0.80" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()"></div>
            <div><label>250Hz</label><input type="number" id="m250" value="0.70" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()"></div>
            <div><label>500Hz</label><input type="number" id="m500" value="0.60" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()"></div>
            <div><label>1kHz</label><input type="number" id="m1k" value="0.60" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()"></div>
            <div><label>2kHz</label><input type="number" id="m2k" value="0.50" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()"></div>
            <div><label>4kHz</label><input type="number" id="m4k" value="0.50" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()"></div>
        </div>
        <div style="font-size:0.65rem; color:var(--dim); margin-top:8px;">
            â€» è‡ªå‹•æ¸¬å®šãŒåˆ©ç”¨ã§ããªã„å ´åˆã€å¤–éƒ¨æ¸¬å®šå™¨ã§å–å¾—ã—ãŸæ®‹éŸ¿æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
        </div>
    </div>
</div>

<div class="section-title">1. åŸºæœ¬ç’°å¢ƒè¨­å®š</div>
<div class="grid-3">
    <div>
        <label>åˆ©ç”¨ç›®çš„ (ç›®æ¨™å€¤)</label>
        <select id="appTarget"></select>
    </div>
    <div>
        <label>éƒ¨å±‹ã‚µã‚¤ã‚º W / D / H [m]</label>
        <div style="display:flex; gap:4px;">
            <input type="number" id="w" value="4.0" step="0.1">
            <input type="number" id="d" value="6.0" step="0.1">
            <input type="number" id="h" value="2.6" step="0.1">
        </div>
    </div>
    <div>
        <label>å£é¢ä»•ä¸Šã’ (ãƒ™ãƒ¼ã‚¹)</label>
        <select id="baseWall"></select>
    </div>
</div>
<div class="grid-3">
    <div><label>å¤©äº•ä»•ä¸Šã’</label><select id="baseCeiling"></select></div>
    <div><label>åºŠä»•ä¸Šã’</label><select id="baseFloor"></select></div>
    <div style="display:flex; align-items:flex-end; padding-bottom:5px;">
        <input type="checkbox" id="showSpecial" style="width:16px; margin-right:8px;">
        <label for="showSpecial" style="margin:0; cursor:pointer; color:var(--accent);">é–‹å£éƒ¨(çª“ç­‰)ã‚’è€ƒæ…®ã™ã‚‹</label>
    </div>
</div>

<div id="specialPanel" style="display:none; background: rgba(56, 139, 253, 0.05); padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px dashed var(--accent);">
    <div class="grid-3" style="grid-template-columns: 2fr 1fr 1fr;">
        <div><label>è¿½åŠ ç´ æ</label><select id="exMat"></select></div>
        <div><label>é¢ç© [ã¡]</label><input type="number" id="exArea" value="2.0" step="0.1"></div>
    </div>
</div>

<div class="section-title">2. è£½å“ã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</div>
<div id="sbInputs"></div>

<div class="res-panel">
    <div class="res-card">
        <label style="font-size:0.6rem">å¹³å‡æ®‹éŸ¿æ™‚é–“ (500Hz-1kHz)</label>
        <div id="postRT_Avg" class="res-val">-</div>
        <div id="targetLabel" style="font-size:0.6rem; color:var(--dim)">ç›®æ¨™: -</div>
        <div id="calcMethod" style="font-size:0.55rem; color:var(--dim); margin-top:3px;">
            <span class="calc-badge" id="methodBadge">SABINE</span>
        </div>
    </div>
    <div class="res-card" id="cardHealth">
        <label style="font-size:0.6rem">å®Ÿç”¨æ€§è©•ä¾¡</label>
        <div id="achievementRate" class="res-val">-</div>
        <div id="healthStatus" style="font-size:0.65rem; font-weight:bold;">-</div>
    </div>
    <div class="res-card">
        <label style="font-size:0.6rem">å°å…¥é¢ç© / æ‹¡æ•£å¯„ä¸åº¦</label>
        <div id="totalPanelArea" class="res-val" style="font-size:1.1rem;">-</div>
        <div id="diffusionBalance" style="font-size:0.65rem; color:var(--primary)">-</div>
    </div>
</div>

<div class="chart-wrapper"><canvas id="rtChart"></canvas></div>

<div class="footer-note">
    <div id="adviceHeader" class="advice-tag"></div>
    <div id="detailedNote" style="font-size:0.75rem;"></div>
</div>

<div id="print-only-notice">
    <strong>ã€ã”æ¡ˆå†…ã€‘</strong><br>
    æœ¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã¯ã€å…¥åŠ›ã•ã‚ŒãŸæ¡ä»¶ä¸‹ã«ãŠã‘ã‚‹ã‚»ãƒ¼ãƒ“ãƒ³å¼ã«åŸºã¥ã„ãŸè¨ˆç®—ç›®å®‰ã§ã‚ã‚Šã€å®Ÿéš›ã®æ–½å·¥ç¾å ´ã®ç’°å¢ƒï¼ˆå®¶å…·ã®é…ç½®ã€ä¸‹åœ°ã®æ§‹é€ ã€æ¸©æ¹¿åº¦ç­‰ï¼‰ã«ã‚ˆã‚Šå¤‰å‹•ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
    ã‚ˆã‚Šé«˜åº¦ãªè©³ç´°è§£æã‚„ã€ãƒ‘ãƒãƒ«ã®å…·ä½“çš„ãªé…ç½®è¨ˆç”»ï¼ˆåå°„éŸ³åˆ†å¸ƒã®æœ€é©åŒ–ãªã©ï¼‰ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€<strong>AFMG EASE</strong> ã«ã‚ˆã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ã¾ãŸã¯å¼Šç¤¾å°‚é–€ã‚¹ã‚¿ãƒƒãƒ•ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
</div>
```

</div>

<script>
const SOUNDBOX_DB = {
    apps: [
        { id: "office", name: "ã‚ªãƒ•ã‚£ã‚¹ / ä¸€èˆ¬ä¼šè­°å®¤ (0.6s)", t: 0.6 },
        { id: "web_mtg", name: "Webä¼šè­°å®¤ / ã‚ªãƒ³ãƒ©ã‚¤ãƒ³MTG (0.4s)", t: 0.4 },
        { id: "studio", name: "ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¸ã‚ª (0.4s)", t: 0.4 },
        { id: "audio", name: "ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ«ãƒ¼ãƒ  / ãƒ›ãƒ¼ãƒ ã‚·ã‚¢ã‚¿ãƒ¼ (0.45s)", t: 0.45 },
        { id: "living", name: "ãƒªãƒ“ãƒ³ã‚° / ä¸€èˆ¬ä½å®… (0.5s)", t: 0.5 },
        { id: "broadcast", name: "é…ä¿¡ã‚¹ã‚¿ã‚¸ã‚ª / ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ (0.35s)", t: 0.35 },
        { id: "classroom", name: "æ•™å®¤ / ã‚»ãƒŸãƒŠãƒ¼ãƒ«ãƒ¼ãƒ  (0.7s)", t: 0.7 },
        { id: "hall", name: "å¤šç›®çš„ãƒ›ãƒ¼ãƒ« / ä½“è‚²é¤¨ (1.2s)", t: 1.2 }
    ],
    materials: {
        "plasterboard": { name: "çŸ³è†ãƒœãƒ¼ãƒ‰ + å£ç´™", data: [0.29, 0.10, 0.05, 0.04, 0.07, 0.09] },
        "concrete": { name: "ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆæ‰“æ”¾ã—", data: [0.01, 0.01, 0.01, 0.02, 0.02, 0.03] },
        "glass": { name: "ã‚¬ãƒ©ã‚¹çª“ / é¡", data: [0.35, 0.25, 0.18, 0.12, 0.07, 0.04] },
        "carpet": { name: "ã‚¿ã‚¤ãƒ«ã‚«ãƒ¼ãƒšãƒƒãƒˆ", data: [0.02, 0.05, 0.10, 0.20, 0.30, 0.40] },
        "wood": { name: "ãƒ•ãƒ­ãƒ¼ãƒªãƒ³ã‚° / æœ¨æ¿", data: [0.15, 0.11, 0.10, 0.07, 0.06, 0.07] },
        "curtain": { name: "ã‚«ãƒ¼ãƒ†ãƒ³ (é‡ç›®/ãƒ—ãƒªãƒ¼ãƒ„æœ‰)", data: [0.07, 0.31, 0.49, 0.75, 0.70, 0.60] },
        "gw_insulation": { name: "ã‚°ãƒ©ã‚¹ã‚¦ãƒ¼ãƒ«æ–­ç†±æ (50mm/32k)", data: [0.25, 0.65, 0.95, 0.98, 0.95, 0.90] }
    },
    products: {
        "STANDARD": {
            name: "1. ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« (EQ Series)",
            models: {
                "STD": { n: "EQ Standard", d: { "30": [0.20, 0.50, 0.95, 1.05, 1.05, 1.00], "60": [0.30, 0.80, 1.10, 1.10, 1.00, 1.00], "120": [0.50, 0.95, 1.10, 1.05, 1.00, 0.95] }, s: { "6x6": 0.36, "6x12": 0.72 } },
                "R": { n: "EQ R (Rococo)", d: { "30": [0.25, 0.55, 0.98, 1.08, 1.07, 1.02], "60": [0.35, 0.85, 1.12, 1.12, 1.02, 1.02], "120": [0.55, 0.98, 1.12, 1.08, 1.02, 0.98] }, s: { "6x6": 0.36, "6x12": 0.72 } },
                "B": { n: "EQ B (Baroque)", d: { "30": [0.22, 0.52, 0.96, 1.06, 1.06, 1.01], "60": [0.32, 0.82, 1.11, 1.11, 1.01, 1.01], "120": [0.52, 0.96, 1.11, 1.06, 1.01, 0.96] }, s: { "6x6": 0.36, "6x12": 0.72 } },
                "F": { n: "EQ Fabric", d: { "30": [0.18, 0.48, 0.93, 1.03, 1.03, 0.98], "60": [0.28, 0.78, 1.08, 1.08, 0.98, 0.98] }, s: { "6x6": 0.36, "6x12": 0.72 } }
            }
        },
        "OFFICE_FABRIC": {
            name: "2. ã‚ªãƒ•ã‚£ã‚¹ç”¨ãƒ•ã‚¡ãƒ–ãƒªãƒƒã‚¯ (Walleasear)",
            models: {
                "EQ30T": { n: "EQ 30T (å¤§é¢ç©æ–½å·¥)", d: { "30": [0.19, 0.49, 0.94, 1.04, 1.04, 0.99] }, s: { "12x6": 0.72, "24x6": 1.44 } },
                "EQ60T": { n: "EQ 60T (å¤§é¢ç©æ–½å·¥)", d: { "60": [0.29, 0.79, 1.09, 1.09, 0.99, 0.99] }, s: { "12x6": 0.72, "24x6": 1.44 } },
                "EQ100T": { n: "EQ 100T (å¤§é¢ç©æ–½å·¥)", d: { "100": [0.45, 0.92, 1.10, 1.07, 1.00, 0.96] }, s: { "12x6": 0.72, "24x6": 1.44 } }
            }
        },
        "ENGINEERING": {
            name: "3. ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°è£½å“",
            models: {
                "MT_BAFFLE": { n: "MT Baffle (å¤©äº•åŠä¸‹ã’)", d: { "40": [0.42, 0.78, 0.95, 0.98, 0.98, 0.96] }, s: { "6x4": 0.24, "12x4": 0.48 } },
                "CM": { n: "CM Series (ã‚¯ãƒ©ã‚¦ãƒ‰/å¤©äº•ç”¨)", d: { "30": [0.21, 0.53, 0.88, 0.96, 0.98, 0.94], "60": [0.38, 0.84, 1.05, 1.08, 1.02, 0.98] }, s: { "6x6": 0.36 } },
                "IMAGINE": { n: "Imagine Panel (æ„åŒ ãƒ‘ãƒãƒ«)", d: { "30": [0.17, 0.46, 0.91, 1.02, 1.03, 0.97] }, s: { "6x6": 0.36 } }
            }
        },
        "BROADBAND": {
            name: "4. ãƒ–ãƒ­ãƒ¼ãƒ‰ãƒãƒ³ãƒ‰å¸éŸ³æ",
            models: {
                "F300H": { n: "F300H (é«˜åŸŸç‰¹åŒ–)", d: { "30": [0.10, 0.35, 0.70, 0.95, 1.08, 1.05] }, s: { "3x3": 0.09 } },
                "F300M": { n: "F300M (ä¸­åŸŸç‰¹åŒ–)", d: { "30": [0.15, 0.55, 0.98, 1.05, 0.95, 0.85] }, s: { "3x3": 0.09 } },
                "F300W": { n: "F300W (ä½åŸŸç‰¹åŒ–)", d: { "30": [0.35, 0.75, 0.95, 0.90, 0.80, 0.70] }, s: { "3x3": 0.09 } }
            }
        },
        "BASSTRAP": {
            name: "5. ãƒ™ãƒ¼ã‚¹ãƒˆãƒ©ãƒƒãƒ— (ä½åŸŸåˆ¶å¾¡)",
            models: {
                "C300W": { n: "C300W (ã‚³ãƒ¼ãƒŠãƒ¼ç”¨)", d: { "300": [0.65, 0.95, 1.05, 1.00, 0.92, 0.85] }, s: { "3x3": 0.09 } },
                "CYLINDER350": { n: "Cylinder 350 (å††ç­’å‹)", d: { "350": [0.70, 0.98, 1.08, 1.02, 0.94, 0.88] }, s: { "custom": 0.12 } }
            }
        },
        "DIFFUSION": {
            name: "6. æ‹¡æ•£ãƒ‘ãƒãƒ« (éŸ¿ãã®èª¿æ•´)",
            models: {
                "CLOUD2C": { n: "Cloud 2C (å¹³é¢æ‹¡æ•£)", d: { "70": [0.05, 0.10, 0.15, 0.12, 0.10, 0.08] }, s: { "6x6": 0.36 }, diffusion: 0.7 },
                "CLOUD2D": { n: "Cloud 2D (å‡¹å‡¸æ‹¡æ•£)", d: { "70": [0.08, 0.15, 0.22, 0.18, 0.15, 0.12] }, s: { "6x6": 0.36 }, diffusion: 0.85 },
                "PEAK_SQ": { n: "Peak SQ (ã‚¹ã‚«ã‚¤ãƒ©ã‚¤ãƒ³)", d: { "80": [0.10, 0.18, 0.25, 0.20, 0.18, 0.15] }, s: { "6x6": 0.36 }, diffusion: 0.9 },
                "QRD_N29": { n: "QRD N29 (äºŒæ¬¡å…ƒæ‹¡æ•£)", d: { "100": [0.12, 0.20, 0.28, 0.25, 0.22, 0.18] }, s: { "6x6": 0.36 }, diffusion: 0.95 }
            }
        },
        "HYBRID": {
            name: "7. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ (å¸éŸ³+æ‹¡æ•£)",
            models: {
                "AQ1000S": { n: "AQ 1000S", d: { "50": [0.25, 0.60, 0.85, 0.88, 0.82, 0.75] }, s: { "6x6": 0.36 }, diffusion: 0.4 },
                "WAVE600": { n: "WAVE 600", d: { "60": [0.30, 0.68, 0.92, 0.95, 0.88, 0.80] }, s: { "6x6": 0.36 }, diffusion: 0.5 },
                "BREEZE": { n: "Breeze (æ„åŒ æ€§ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰)", d: { "40": [0.20, 0.55, 0.88, 0.92, 0.85, 0.78] }, s: { "6x6": 0.36 }, diffusion: 0.35 }
            }
        }
    }
};

const FREQS = [125, 250, 500, 1000, 2000, 4000];
let chart;
let selectedSpecs = [{}, {}, {}];
let lastData = {};
let currentMode = 'sim';
let measurementData = null;

function init() {
    const appSelect = document.getElementById('appTarget');
    SOUNDBOX_DB.apps.forEach((app, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = app.name;
        appSelect.appendChild(option);
    });

    const materialSelects = ['baseWall', 'baseCeiling', 'baseFloor', 'exMat'];
    materialSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        for (let key in SOUNDBOX_DB.materials) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = SOUNDBOX_DB.materials[key].name;
            select.appendChild(option);
        }
    });

    const sbInputsContainer = document.getElementById('sbInputs');
    sbInputsContainer.innerHTML = '';
    for (let i = 0; i < 3; i++) {
        const row = document.createElement('div');
        row.className = 'grid-row';
        row.innerHTML = `
            <div><label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label><select id="cat_${i}" onchange="onCategoryChange(${i})"></select></div>
            <div class="custom-select-container">
                <div class="custom-select-trigger" id="trigger_${i}" onclick="togglePanel(${i})">è£½å“ã‚¹ãƒšãƒƒã‚¯ã‚’é¸æŠ...</div>
                <div class="sub-panel" id="panel_${i}">
                    <div class="panel-cols">
                        <div id="col_model_${i}"></div>
                        <div id="col_thick_${i}"></div>
                        <div id="col_size_${i}"></div>
                    </div>
                </div>
            </div>
            <input type="number" id="qty_${i}" value="0" min="0" step="1" oninput="calculate()">
            <div id="unitArea_${i}" style="font-size:0.65rem; color:var(--dim); text-align:center;">-</div>
            <div id="totalArea_${i}" style="font-size:0.7rem; color:var(--primary); text-align:right; font-weight:bold;">-</div>
        `;
        sbInputsContainer.appendChild(row);

        const catSelect = document.getElementById(`cat_${i}`);
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'é¸æŠã—ã¦ãã ã•ã„...';
        catSelect.appendChild(defaultOption);
        for (let catKey in SOUNDBOX_DB.products) {
            const option = document.createElement('option');
            option.value = catKey;
            option.textContent = SOUNDBOX_DB.products[catKey].name;
            catSelect.appendChild(option);
        }
    }

    document.getElementById('appTarget').addEventListener('change', calculate);
    document.getElementById('w').addEventListener('input', calculate);
    document.getElementById('d').addEventListener('input', calculate);
    document.getElementById('h').addEventListener('input', calculate);
    document.getElementById('baseWall').addEventListener('change', calculate);
    document.getElementById('baseCeiling').addEventListener('change', calculate);
    document.getElementById('baseFloor').addEventListener('change', calculate);
    document.getElementById('exArea').addEventListener('input', calculate);
    document.getElementById('exMat').addEventListener('change', calculate);
    document.getElementById('showSpecial').addEventListener('change', function() {
        document.getElementById('specialPanel').style.display = this.checked ? 'block' : 'none';
        calculate();
    });
    calculate();
}

function setMode(mode) {
    currentMode = mode;
    const btnSim = document.getElementById('btnSim');
    const btnMeasure = document.getElementById('btnMeasure');
    if (mode === 'sim') {
        btnSim.classList.add('active');
        btnSim.classList.remove('measure');
        btnMeasure.classList.remove('active', 'measure');
        document.getElementById('measurementPanel').style.display = 'none';
    } else {
        btnSim.classList.remove('active');
        btnMeasure.classList.add('active', 'measure');
        document.getElementById('measurementPanel').style.display = 'block';
        enumerateDevices();
    }
    const methodBadge = document.getElementById('methodBadge');
    methodBadge.textContent = mode === 'sim' ? 'SABINE' : 'EYRING';
    methodBadge.style.background = mode === 'sim' ? 'var(--accent)' : 'var(--warning)';
    calculate();
}

async function enumerateDevices() {
    const statusEl = document.getElementById('measureStatus');
    const micSelect = document.getElementById('micSelect');
    const spkSelect = document.getElementById('spkSelect');
    try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) throw new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome/Edge/Firefoxã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') throw new Error('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã«ã‚ˆã‚Šã€HTTPSãƒšãƒ¼ã‚¸ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚');
        statusEl.textContent = 'ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­...';
        statusEl.className = 'status-msg calibrating';
        let stream;
        try {
            stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });
        } catch (permError) {
            if (permError.name === 'NotAllowedError') throw new Error('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼æ¨ªã®ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
            else if (permError.name === 'NotFoundError') throw new Error('ãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒã‚¤ã‚¯ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            else throw new Error('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + permError.message);
        }
        statusEl.textContent = 'ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ä¸­...';
        if (stream) stream.getTracks().forEach(track => track.stop());
        const devices = await navigator.mediaDevices.enumerateDevices();
        micSelect.innerHTML = '<option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>';
        spkSelect.innerHTML = '<option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>';
        let micCount = 0, spkCount = 0;
        devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.textContent = device.label || `${device.kind === 'audioinput' ? 'ãƒã‚¤ã‚¯' : 'ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼'} ${device.deviceId.substr(0, 8)}...`;
            if (device.kind === 'audioinput') { micSelect.appendChild(option); micCount++; }
            else if (device.kind === 'audiooutput') { spkSelect.appendChild(option); spkCount++; }
        });
        if (micCount > 0) {
            statusEl.textContent = `âœ… ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºå®Œäº†: ãƒã‚¤ã‚¯ ${micCount}å°ã€ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ ${spkCount}å°`;
            statusEl.className = 'status-msg ready';
            if (micSelect.options.length > 1) micSelect.selectedIndex = 1;
            if (spkSelect.options.length > 1) spkSelect.selectedIndex = 1;
        } else {
            statusEl.textContent = 'âš ï¸ ãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒã‚¤ã‚¯ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            statusEl.className = 'status-msg error';
        }
    } catch (error) {
        statusEl.textContent = 'âŒ ' + (error.message || 'ãƒ‡ãƒã‚¤ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        statusEl.className = 'status-msg error';
        micSelect.innerHTML = '<option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>';
        spkSelect.innerHTML = '<option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>';
    }
}

function onCategoryChange(index) {
    selectedSpecs[index] = {};
    document.getElementById(`trigger_${index}`).textContent = 'è£½å“ã‚¹ãƒšãƒƒã‚¯ã‚’é¸æŠ...';
    document.getElementById(`panel_${index}`).classList.remove('active');
    document.getElementById(`unitArea_${index}`).textContent = '-';
    document.getElementById(`totalArea_${index}`).textContent = '-';
    renderPanel(index);
    calculate();
}

function togglePanel(index) {
    const panel = document.getElementById(`panel_${index}`);
    const isActive = panel.classList.contains('active');
    document.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
    if (!isActive) { panel.classList.add('active'); renderPanel(index); }
}

function renderPanel(index) {
    const categoryKey = document.getElementById(`cat_${index}`).value;
    if (!categoryKey) {
        document.getElementById(`col_model_${index}`).innerHTML = '<div class="col-title">MODEL</div>';
        document.getElementById(`col_thick_${index}`).innerHTML = '<div class="col-title">THICKNESS</div>';
        document.getElementById(`col_size_${index}`).innerHTML = '<div class="col-title">SIZE</div>';
        return;
    }
    const category = SOUNDBOX_DB.products[categoryKey];
    const spec = selectedSpecs[index];
    const modelCol = document.getElementById(`col_model_${index}`);
    modelCol.innerHTML = '<div class="col-title">MODEL</div>';
    for (let modelKey in category.models) {
        const modelDiv = document.createElement('div');
        modelDiv.className = 'col-item' + (spec.model === modelKey ? ' selected' : '');
        modelDiv.textContent = category.models[modelKey].n;
        modelDiv.onclick = () => selectModel(index, categoryKey, modelKey);
        modelCol.appendChild(modelDiv);
    }
    const thickCol = document.getElementById(`col_thick_${index}`);
    thickCol.innerHTML = '<div class="col-title">THICKNESS</div>';
    if (spec.model) {
        const model = category.models[spec.model];
        for (let thickKey in model.d) {
            const thickDiv = document.createElement('div');
            thickDiv.className = 'col-item' + (spec.thick === thickKey ? ' selected' : '');
            thickDiv.textContent = thickKey + 'mm';
            thickDiv.onclick = () => selectThickness(index, categoryKey, spec.model, thickKey);
            thickCol.appendChild(thickDiv);
        }
    }
    const sizeCol = document.getElementById(`col_size_${index}`);
    sizeCol.innerHTML = '<div class="col-title">SIZE</div>';
    if (spec.model && spec.thick) {
        const model = category.models[spec.model];
        for (let sizeKey in model.s) {
            const sizeDiv = document.createElement('div');
            sizeDiv.className = 'col-item' + (spec.size === sizeKey ? ' selected' : '');
            sizeDiv.textContent = sizeKey;
            sizeDiv.onclick = () => selectSize(index, categoryKey, spec.model, spec.thick, sizeKey);
            sizeCol.appendChild(sizeDiv);
        }
    }
}

function selectModel(index, categoryKey, modelKey) { selectedSpecs[index] = { category: categoryKey, model: modelKey }; renderPanel(index); }
function selectThickness(index, categoryKey, modelKey, thickKey) { selectedSpecs[index].thick = thickKey; renderPanel(index); }
function selectSize(index, categoryKey, modelKey, thickKey, sizeKey) {
    selectedSpecs[index].size = sizeKey;
    const model = SOUNDBOX_DB.products[categoryKey].models[modelKey];
    document.getElementById(`trigger_${index}`).textContent = `${model.n} / ${thickKey}mm / ${sizeKey}`;
    document.getElementById(`unitArea_${index}`).textContent = model.s[sizeKey].toFixed(2) + 'ã¡';
    document.getElementById(`panel_${index}`).classList.remove('active');
    calculate();
}

function prepareForPrint() { window.print(); }

function calculate() {
    const w = parseFloat(document.getElementById('w').value) || 0.1;
    const d = parseFloat(document.getElementById('d').value) || 0.1;
    const h = parseFloat(document.getElementById('h').value) || 0.1;
    const V = w * d * h;
    const S_total = 2 * (w * d + d * h + h * w);
    const S_wall = 2 * (d * h + h * w);
    const S_ceiling = w * d;
    const S_floor = w * d;
    if (V <= 0 || S_total <= 0) return;
    const L_mean = (4 * V) / S_total;
    const diffusionIndicator = (L_mean * 0.12).toFixed(2);
    const appIndex = parseInt(document.getElementById('appTarget').value) || 0;
    const targetObj = SOUNDBOX_DB.apps[appIndex];
    const targetRT = targetObj.t;
    const wallMat = SOUNDBOX_DB.materials[document.getElementById('baseWall').value];
    const ceilingMat = SOUNDBOX_DB.materials[document.getElementById('baseCeiling').value];
    const floorMat = SOUNDBOX_DB.materials[document.getElementById('baseFloor').value];
    let exArea = 0, exMat = null;
    if (document.getElementById('showSpecial').checked) {
        exArea = parseFloat(document.getElementById('exArea').value) || 0;
        exMat = SOUNDBOX_DB.materials[document.getElementById('exMat').value];
    }
    const actualWallArea = Math.max(0, S_wall - exArea);
    const rt_before = [], rt_after = [];
    const m_coeffs = [0, 0, 0, 0, 0.002, 0.007];
    for (let i = 0; i < 6; i++) {
        let A_base = actualWallArea * wallMat.data[i] + S_ceiling * ceilingMat.data[i] + S_floor * floorMat.data[i];
        if (exArea > 0 && exMat) A_base += exArea * exMat.data[i];
        const airAbsorption = 4 * m_coeffs[i] * V;
        let rt_b = (currentMode === 'measure' && measurementData && measurementData[i]) ? measurementData[i] : (0.161 * V) / (A_base + airAbsorption);
        rt_before.push(rt_b);
        let A_panels = 0;
        for (let panelIdx = 0; panelIdx < 3; panelIdx++) {
            const spec = selectedSpecs[panelIdx];
            const qty = parseInt(document.getElementById(`qty_${panelIdx}`).value) || 0;
            if (spec.category && spec.model && spec.thick && spec.size && qty > 0) {
                const product = SOUNDBOX_DB.products[spec.category].models[spec.model];
                A_panels += product.s[spec.size] * qty * (product.d[spec.thick][i] - wallMat.data[i]);
            }
        }
        const A_total = A_base + A_panels + airAbsorption;
        const avgAlpha = Math.min(A_total / S_total, 0.999);
        rt_after.push(currentMode === 'measure' ? (0.161 * V) / (-S_total * Math.log(1 - avgAlpha) + airAbsorption) : (0.161 * V) / A_total);
    }
    const avgRT_after = (rt_after[2] + rt_after[3]) / 2;
    const avgRT_before = (rt_before[2] + rt_before[3]) / 2;
    let totalPanelM2 = 0;
    for (let panelIdx = 0; panelIdx < 3; panelIdx++) {
        const spec = selectedSpecs[panelIdx];
        const qty = parseInt(document.getElementById(`qty_${panelIdx}`).value) || 0;
        if (spec.category && spec.model && spec.size && qty > 0) {
            const unitArea = SOUNDBOX_DB.products[spec.category].models[spec.model].s[spec.size];
            totalPanelM2 += unitArea * qty;
            document.getElementById(`totalArea_${panelIdx}`).textContent = (unitArea * qty).toFixed(2) + 'ã¡';
        } else {
            document.getElementById(`totalArea_${panelIdx}`).textContent = '-';
        }
    }
    const usableSurface = S_wall * 0.8;
    const achievementRate = (targetRT / avgRT_after) * 100;
    updateUI(rt_before, rt_after, avgRT_before, avgRT_after, targetRT, targetObj, achievementRate, totalPanelM2, usableSurface, V, diffusionIndicator);
}

function updateUI(rt_before, rt_after, avgBefore, avgAfter, targetRT, targetObj, achievementRate, totalPanelM2, usableSurface, V, diffusionIndicator) {
    document.getElementById('postRT_Avg').textContent = avgAfter.toFixed(2) + 's';
    document.getElementById('targetLabel').textContent = `ç›®æ¨™: ${targetRT}s`;
    document.getElementById('achievementRate').textContent = achievementRate.toFixed(0) + '%';
    document.getElementById('totalPanelArea').textContent = `${totalPanelM2.toFixed(1)} / ${usableSurface.toFixed(1)}ã¡`;
    document.getElementById('diffusionBalance').textContent = `æ‹¡æ•£å¯„ä¸åº¦: ${diffusionIndicator}`;
    const cardHealth = document.getElementById('cardHealth');
    const healthStatus = document.getElementById('healthStatus');
    const adviceHeader = document.getElementById('adviceHeader');
    const detailedNote = document.getElementById('detailedNote');
    let status, statusColor, adviceTagColor, adviceText;
    if (totalPanelM2 > usableSurface) {
        status = 'è¨­ç½®é™ç•Œè¶…é'; statusColor = 'var(--danger)'; adviceTagColor = '#ff7b72';
        adviceHeader.textContent = 'FAIL'; adviceHeader.style.background = adviceTagColor;
        adviceText = 'å£é¢ã®æœ‰åŠ¹é¢ç©ï¼ˆ80%ï¼‰ã‚’è¶…ãˆã‚‹ãƒ‘ãƒãƒ«ãŒé…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‘ãƒãƒ«æšæ•°ã‚’æ¸›ã‚‰ã™ã‹ã€ã‚ˆã‚Šåšå‹ã®ãƒ‘ãƒãƒ«ã¸ã®å¤‰æ›´ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚';
    } else if (achievementRate >= 120) {
        status = 'éŸ¿ããŒå°‘ãªã„'; statusColor = 'var(--caution)'; adviceTagColor = '#f0883e';
        adviceHeader.textContent = 'OVER'; adviceHeader.style.background = adviceTagColor;
        adviceText = 'ç©ºé–“ãŒãƒ‡ãƒƒãƒ‰éãã‚‹å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚æ‹¡æ•£ãƒ‘ãƒãƒ«ã‚’æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚';
    } else if (achievementRate >= 100) {
        status = 'ç†æƒ³çš„'; statusColor = 'var(--success)'; adviceTagColor = '#39d353';
        adviceHeader.textContent = 'IDEAL'; adviceHeader.style.background = adviceTagColor;
        adviceText = 'ç†æƒ³çš„ãªæ•°å€¤ã§ã™ã€‚ç›®æ¨™ã®æ®‹éŸ¿æ™‚é–“ã‚’é”æˆã—ã¦ã„ã¾ã™ã€‚';
    } else if (achievementRate >= 80) {
        status = 'å®Ÿç”¨ãƒ¬ãƒ™ãƒ«'; statusColor = 'var(--accent)'; adviceTagColor = '#388bfd';
        adviceHeader.textContent = 'GOOD'; adviceHeader.style.background = adviceTagColor;
        adviceText = 'å®Ÿç”¨ä¸Šååˆ†ãªå°å…¥åŠ¹æœã§ã™ã€‚ä½åŸŸã®åˆ¶å¾¡ã«ã¯åšå‹ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚';
    } else {
        status = 'å¸éŸ³ä¸è¶³'; statusColor = 'var(--danger)'; adviceTagColor = '#ff7b72';
        adviceHeader.textContent = 'UNDER'; adviceHeader.style.background = adviceTagColor;
        adviceText = 'ç›®æ¨™æ®‹éŸ¿æ™‚é–“ã«é”ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ‘ãƒãƒ«å¢—è¨­ã‚’æ¨å¥¨ã—ã¾ã™ã€‚';
    }
    healthStatus.textContent = status;
    healthStatus.style.color = statusColor;
    cardHealth.style.borderColor = statusColor;
    if (V < 30) {
        adviceText += '<br><br><strong style="color:#ffb86c;">âš ï¸ Small Room Analysis</strong><br>æœ¬ç©ºé–“ã¯å®¹ç©ãŒå°ã•ã„ãŸã‚ã€è¨ˆç®—ä¸Šã®æ•°å€¤ã‚ˆã‚Šã‚‚ã€å¹³è¡Œé¢ã§ç™ºç”Ÿã™ã‚‹å®šåœ¨æ³¢ï¼ˆãƒ–ãƒ¼ãƒŸãƒ³ã‚°ï¼‰ã®æŠ‘åˆ¶ãŒé‡è¦ã§ã™ã€‚å£é¢ã®ä¸­å¤®ã ã‘ã§ãªãã€å…¥éš…ï¼ˆã‚³ãƒ¼ãƒŠãƒ¼ï¼‰ã¸ã®å¸éŸ³æé…ç½®ã‚’å„ªå…ˆã™ã‚‹ã“ã¨ã§ã€ä½åŸŸã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’åŠ¹ç‡çš„ã«å‡¦ç†ã§ãã¾ã™ã€‚';
    }
    if (rt_after[0] > avgAfter * 1.5) {
        adviceText += '<br><br><strong style="color:#ffb86c;">âš ï¸ 125Hz ä½åŸŸæ®‹éŸ¿è­¦å‘Š</strong><br>125Hzã®æ®‹éŸ¿æ™‚é–“ãŒçªå‡ºã—ã¦ã„ã¾ã™ã€‚ä½åŸŸã®åˆ¶å¾¡ã«ã¯120mmåšã®ãƒ‘ãƒãƒ«ã€ã¾ãŸã¯ã‚³ãƒ¼ãƒŠãƒ¼é…ç½®ã®ãƒ™ãƒ¼ã‚¹ãƒˆãƒ©ãƒƒãƒ—ã‚’æ¨å¥¨ã—ã¾ã™ã€‚';
    }
    detailedNote.innerHTML = adviceText;
    updateChart(rt_before, rt_after, targetRT);
    lastData = { rt_after: avgAfter, rt_before: avgBefore, targetRT, achievementRate, totalPanelM2, V, status };
}

window.addEventListener('DOMContentLoaded', init);
</script>

<script>
// ========================================
// Web Worker: 1/3ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–å¸¯åŸŸè§£æã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆRev 18.0 Part 4ï¼‰
// å‡¦ç†ãƒ•ãƒ­ãƒ¼: IRæŠ½å‡º â†’ BPF â†’ SNR â†’ ã‚·ãƒ¥ãƒ¬ãƒ¼ãƒ€ãƒ¼ç©åˆ† â†’ RTè¨ˆç®—
// ========================================
const workerCode = `
'use strict';

// INITå—ä¿¡ã§è¨­å®šã‚’ä¿æŒ
let _fs  = 48000;
let _cfg = null;

self.onmessage = function(e) {
    const msg = e.data;
    if (msg.type === 'INIT') {
        _fs  = msg.sampleRate;
        _cfg = msg.config;
        return;
    }
    if (msg.type === 'ANALYZE_BAND') {
        analyzeBand(msg);
    }
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Cooley-Tukey FFTï¼ˆåŸºæ•°2ãƒ»ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ï¼‰
   å‚è€ƒ: J.W.Cooley & J.W.Tukey (1965)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function nextPow2(n) {
    let p = 1;
    while (p < n) p <<= 1;
    return p;
}

function fft(re, im) {
    const N = re.length;
    // ãƒ“ãƒƒãƒˆé€†é †ä¸¦ã¹æ›¿ãˆ
    for (let i = 1, j = 0; i < N; i++) {
        let bit = N >> 1;
        for (; j & bit; bit >>= 1) j ^= bit;
        j ^= bit;
        if (i < j) {
            let t;
            t = re[i]; re[i] = re[j]; re[j] = t;
            t = im[i]; im[i] = im[j]; im[j] = t;
        }
    }
    // ãƒã‚¿ãƒ•ãƒ©ã‚¤æ¼”ç®—
    for (let len = 2; len <= N; len <<= 1) {
        const ang = -2.0 * Math.PI / len;
        const wRe = Math.cos(ang);
        const wIm = Math.sin(ang);
        for (let i = 0; i < N; i += len) {
            let uRe = 1.0, uIm = 0.0;
            const half = len >> 1;
            for (let k = 0; k < half; k++) {
                const m   = i + k + half;
                const vRe = re[m] * uRe - im[m] * uIm;
                const vIm = re[m] * uIm + im[m] * uRe;
                re[m]   = re[i + k] - vRe;
                im[m]   = im[i + k] - vIm;
                re[i+k] += vRe;
                im[i+k] += vIm;
                const nRe = uRe * wRe - uIm * wIm;
                uIm = uRe * wIm + uIm * wRe;
                uRe = nRe;
            }
        }
    }
}

function ifft(re, im) {
    const N = re.length;
    for (let i = 0; i < N; i++) im[i] = -im[i];
    fft(re, im);
    for (let i = 0; i < N; i++) {
        re[i] /=  N;
        im[i]  = -im[i] / N;
    }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   é€†ç•³ã¿è¾¼ã¿ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ‘ãƒ«ã‚¹å¿œç­”(IR)æŠ½å‡º
   H(f) = Y(f) Â· X*(f) / (|X(f)|Â² + Îµ)
   æ­£è¦åŒ–é€†ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆWienerãƒ•ã‚£ãƒ«ã‚¿å½¢å¼ï¼‰
   ISO 3382-1:2009 Annex Aæº–æ‹ 
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function extractIR(recorded, sweep) {
    const N = nextPow2((recorded.length + sweep.length - 1) * 2);
    const yRe = new Float64Array(N);
    const yIm = new Float64Array(N);
    const xRe = new Float64Array(N);
    const xIm = new Float64Array(N);

    for (let i = 0; i < recorded.length; i++) yRe[i] = recorded[i];
    for (let i = 0; i < sweep.length;    i++) xRe[i] = sweep[i];

    fft(yRe, yIm);
    fft(xRe, xIm);

    // æ­£è¦åŒ–: ã‚¼ãƒ­é™¤ç®—ãƒ»ä½ã‚¨ãƒãƒ«ã‚®ãƒ¼å¸¯åŸŸã®ç™ºæ•£ã‚’é˜²æ­¢
    const eps = 1e-9;
    const hRe = new Float64Array(N);
    const hIm = new Float64Array(N);
    for (let i = 0; i < N; i++) {
        const denom = xRe[i]*xRe[i] + xIm[i]*xIm[i] + eps;
        hRe[i] = (yRe[i]*xRe[i] + yIm[i]*xIm[i]) / denom;
        hIm[i] = (yIm[i]*xRe[i] - yRe[i]*xIm[i]) / denom;
    }

    ifft(hRe, hIm);

    // å®Ÿéƒ¨ã®ã¿ï¼ˆã‚¤ãƒ³ãƒ‘ãƒ«ã‚¹å¿œç­”ï¼‰ã‚’éŒ²éŸ³é•·ã§åˆ‡ã‚Šå–ã£ã¦è¿”å´
    return new Float64Array(hRe.buffer, 0, recorded.length);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   6æ¬¡ Butterworth BPFï¼ˆ2æ¬¡Biquad Ã— 3æ®µã‚«ã‚¹ã‚±ãƒ¼ãƒ‰ï¼‰
   ANSI S1.11 / ISO 3382æº–æ‹ 
   ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰è£œæ­£: Q_sec = Q_target / sqrt(2^(1/k) - 1)
   å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒä¸€ä¿‚æ•°ï¼ˆcenter fcå…±é€šï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function designButterworthBPF(fc, fs, order, margin) {
    const nSec = order / 2; // 6æ¬¡ â†’ 3ã‚»ã‚¯ã‚·ãƒ§ãƒ³

    // 1/3ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–å¸¯åŸŸå¹…ï¼ˆ5%å†…å´ã«çµã‚‹ï¼‰
    const fL = (fc / Math.SQRT2) * (1.0 + margin);
    const fH = (fc * Math.SQRT2) * (1.0 - margin);
    const Q_target = fc / (fH - fL);

    // ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰è£œæ­£: kæ®µã§æ‰€å®šã®-3dBå¸¯åŸŸå¹…ã‚’ä¿è¨¼
    const Q_sec = Q_target / Math.sqrt(Math.pow(2, 1.0 / nSec) - 1.0);

    const w0    = 2.0 * Math.PI * fc / fs;
    const alpha = Math.sin(w0) / (2.0 * Q_sec);
    const cosW0 = Math.cos(w0);
    const a0    = 1.0 + alpha;

    const sec = {
        b0:  alpha / a0,
        b1:  0.0,
        b2: -alpha / a0,
        a1: -2.0 * cosW0 / a0,
        a2: (1.0 - alpha) / a0
    };

    // 3ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯åŒä¸€ä¿‚æ•°
    return [{ ...sec }, { ...sec }, { ...sec }];
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Biquadã‚«ã‚¹ã‚±ãƒ¼ãƒ‰é©ç”¨ï¼ˆæ™‚é–“åŸŸIIRãƒ•ã‚£ãƒ«ã‚¿ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function applyBiquadCascade(signal, sections) {
    let buf = new Float64Array(signal);
    for (const s of sections) {
        const out = new Float64Array(buf.length);
        let x1 = 0.0, x2 = 0.0, y1 = 0.0, y2 = 0.0;
        for (let i = 0; i < buf.length; i++) {
            const x0 = buf[i];
            const y0 = s.b0*x0 + s.b1*x1 + s.b2*x2
                     - s.a1*y1 - s.a2*y2;
            out[i] = y0;
            x2 = x1; x1 = x0;
            y2 = y1; y1 = y0;
        }
        buf = out;
    }
    return buf;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SNRè¨ˆç®—
   IRãƒ”ãƒ¼ã‚¯ä»˜è¿‘ã‚¨ãƒãƒ«ã‚®ãƒ¼ vs æœ«å°¾ãƒã‚¤ã‚ºãƒ•ãƒ­ã‚¢ã®
   ã‚¨ãƒãƒ«ã‚®ãƒ¼å¯†åº¦æ¯”ï¼ˆã‚µãƒ³ãƒ—ãƒ«æ•°æ­£è¦åŒ–ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function calcSNR(ir) {
    const N = ir.length;

    // ãƒ”ãƒ¼ã‚¯ä½ç½®ã‚’æ¢ã™
    let peakIdx = 0, peakVal = 0;
    for (let i = 0; i < N; i++) {
        const v = Math.abs(ir[i]);
        if (v > peakVal) { peakVal = v; peakIdx = i; }
    }

    // ãƒ”ãƒ¼ã‚¯å¾Œ15%ã‚’IRå¸¯ã€æœ«å°¾25%ã‚’ãƒã‚¤ã‚ºå¸¯
    const irEnd   = Math.min(N, peakIdx + Math.floor(N * 0.15));
    const nStart  = Math.floor(N * 0.75);
    const irCount = irEnd - peakIdx;
    const nCount  = N - nStart;

    if (irCount <= 0 || nCount <= 0) return 60;

    let irE = 0, nE = 0;
    for (let i = peakIdx; i < irEnd; i++) irE += ir[i]*ir[i];
    for (let i = nStart;  i < N;     i++) nE  += ir[i]*ir[i];

    if (nE < 1e-20) return 60;
    return 10.0 * Math.log10((irE / irCount) / (nE / nCount));
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ã‚·ãƒ¥ãƒ¬ãƒ¼ãƒ€ãƒ¼ç©åˆ†ï¼ˆå¾Œé€€ç´¯ç© + å‹•çš„æ‰“ã¡åˆ‡ã‚Šï¼‰
   EDC(t) = âˆ«[tâ†’âˆ] hÂ²(Ï„)dÏ„
   æ‰“ã¡åˆ‡ã‚Š: ãƒã‚¤ã‚ºå¯†åº¦ã®3å€ã‚’ä¸‹å›ã£ãŸæ™‚ç‚¹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function schroederIntegral(ir) {
    const N = ir.length;

    // ãƒã‚¤ã‚ºå¯†åº¦æ¨å®šï¼ˆæœ«å°¾25%ï¼‰
    const nStart = Math.floor(N * 0.75);
    let nE = 0;
    for (let i = nStart; i < N; i++) nE += ir[i]*ir[i];
    const noiseDensity = nE / (N - nStart);

    // å¾Œé€€ç©åˆ†
    const cum = new Float64Array(N);
    cum[N-1] = ir[N-1]*ir[N-1];
    for (let i = N-2; i >= 0; i--) cum[i] = cum[i+1] + ir[i]*ir[i];

    // dBå¤‰æ›ã¨å‹•çš„æ‰“ã¡åˆ‡ã‚Š
    const peak = cum[0] > 0 ? cum[0] : 1e-20;
    const edcDB = new Float64Array(N).fill(-999);
    let truncIdx = N - 1;

    for (let i = 0; i < N; i++) {
        // æ®‹ä½™ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒãƒã‚¤ã‚ºå¯†åº¦Ã—æ®‹ã‚µãƒ³ãƒ—ãƒ«æ•°ã®3å€ã‚’ä¸‹å›ã£ãŸã‚‰æ‰“ã¡åˆ‡ã‚Š
        if (cum[i] <= noiseDensity * (N - i) * 3.0) {
            truncIdx = i;
            break;
        }
        edcDB[i] = 10.0 * Math.log10(cum[i] / peak);
    }

    return { edcDB, truncIdx };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RTè¨ˆç®—ï¼ˆæœ€å°äºŒä¹—ç·šå½¢å›å¸°ï¼‰
   T60â†’T30â†’T20 ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
   ISO 3382-2:2008 æº–æ‹ 
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function calcRT(edcDB, truncIdx, fs) {
    // T60: -5dB â†’ -65dB
    const r60 = lsqRT(edcDB, truncIdx, fs, -5, -65);
    if (r60 !== null) return { rt60: r60,       method: 'T60' };

    // T30: -5dB â†’ -35dB â†’ Ã—2å¤–æŒ¿
    const r30 = lsqRT(edcDB, truncIdx, fs, -5, -35);
    if (r30 !== null) return { rt60: r30 * 2.0, method: 'T30' };

    // T20: -5dB â†’ -25dB â†’ Ã—3å¤–æŒ¿
    const r20 = lsqRT(edcDB, truncIdx, fs, -5, -25);
    if (r20 !== null) return { rt60: r20 * 3.0, method: 'T20' };

    return null;
}

function lsqRT(edcDB, truncIdx, fs, startDB, endDB) {
    let s = -1, e = -1;
    for (let i = 0; i < truncIdx; i++) {
        if (s < 0 && edcDB[i] <= startDB) { s = i; continue; }
        if (s >= 0 && edcDB[i] <= endDB)  { e = i; break; }
    }
    if (s < 0 || e < 0 || (e - s) < 10) return null;

    let n = 0, sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
    for (let i = s; i <= e; i++) {
        const t = i / fs;
        sumX  += t;
        sumY  += edcDB[i];
        sumXY += t * edcDB[i];
        sumXX += t * t;
        n++;
    }
    const denom = n * sumXX - sumX * sumX;
    if (Math.abs(denom) < 1e-15) return null;

    const slope = (n * sumXY - sumX * sumY) / denom;
    if (slope >= 0) return null; // æ¸›è¡°ã—ã¦ã„ãªã„

    return (endDB - startDB) / slope;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ãƒ¡ã‚¤ãƒ³è§£æé–¢æ•°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function analyzeBand(msg) {
    const { band, recorded, sweep } = msg;
    const fs       = _fs;
    const minSnr   = (_cfg && _cfg.analysis) ? _cfg.analysis.minSnr   : 15.0;
    const bpfOrder = (_cfg && _cfg.analysis) ? _cfg.analysis.bpfOrder :  6;
    const bpfMargin= (_cfg && _cfg.analysis) ? _cfg.analysis.bpfMargin: 0.05;

    try {
        const recF32 = new Float32Array(recorded);
        const swpF32 = new Float32Array(sweep);

        // â‘  IRæŠ½å‡ºï¼ˆé€†ç•³ã¿è¾¼ã¿ï¼‰
        const ir = extractIR(recF32, swpF32);

        // â‘¡ 6æ¬¡Butterworth BPFé©ç”¨
        const sections  = designButterworthBPF(band, fs, bpfOrder, bpfMargin);
        const irFiltered = applyBiquadCascade(ir, sections);

        // â‘¢ SNRåˆ¤å®š
        const snr = calcSNR(irFiltered);
        if (snr < minSnr) {
            self.postMessage({
                type: 'bandResult', band, rt60: null,
                snr: +snr.toFixed(1),
                reason: 'SNR ' + snr.toFixed(1) + 'dB < ' + minSnr + 'dB'
            });
            return;
        }

        // â‘£ ã‚·ãƒ¥ãƒ¬ãƒ¼ãƒ€ãƒ¼ç©åˆ†
        const { edcDB, truncIdx } = schroederIntegral(irFiltered);

        // â‘¤ RTè¨ˆç®—
        const rtResult = calcRT(edcDB, truncIdx, fs);
        if (!rtResult) {
            self.postMessage({
                type: 'bandResult', band, rt60: null,
                snr: +snr.toFixed(1),
                reason: 'RTè¨ˆç®—å¤±æ•—ï¼ˆæ¸›è¡°ã‚«ãƒ¼ãƒ–ä¸ååˆ†ï¼‰'
            });
            return;
        }

        self.postMessage({
            type:   'bandResult',
            band,
            rt60:   +rtResult.rt60.toFixed(3),
            snr:    +snr.toFixed(1),
            method: rtResult.method
        });

    } catch (err) {
        self.postMessage({
            type: 'bandResult', band, rt60: null, snr: 0,
            reason: 'Workerå†…éƒ¨ã‚¨ãƒ©ãƒ¼: ' + err.message
        });
    }
}
`;

let measurementWorker = null;

function initWorker() {
    const blob = new Blob([workerCode], { type: 'text/javascript' });
    measurementWorker = new Worker(URL.createObjectURL(blob));
    measurementWorker.onmessage = function(e) {
        if (e.data.type === 'debug') return;
        if (e.data.type === 'result') handleMeasurementResult(e.data);
        if (e.data.type === 'error') handleMeasurementError(e.data.message);
    };
    measurementWorker.onerror = function(err) { console.error('Worker error:', err); };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Part 5: æ¸¬å®šçµæœãƒãƒ³ãƒ‰ãƒ©
// 18ãƒãƒ³ãƒ‰ï¼ˆ1/3octï¼‰â†’ 6ãƒãƒ³ãƒ‰ï¼ˆã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ï¼‰é›†ç´„
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleMeasurementResult(data) {
    const statusEl   = document.getElementById('measureStatus');
    const startBtn   = document.getElementById('startMeasBtn');
    const progressEl = document.getElementById('measureProgress');
    const warnEl     = document.getElementById('remeasureWarning');

    // UIåˆæœŸåŒ–
    startBtn.disabled = false;
    progressEl.style.display = 'none';
    document.getElementById('recordingAlert').classList.remove('active');

    const thirdResults = data.thirdResults; // 18æœ¬ã®1/3ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–RT60é…åˆ—
    const octaveDefs   = MEASUREMENT_CONFIG.octaveBands; // 6ã‚°ãƒ«ãƒ¼ãƒ—å®šç¾©
    const octaveResults = new Array(6).fill(null);

    let validOctaveCount = 0;
    const missingBands = [];

    // â”€â”€ 18ãƒãƒ³ãƒ‰ â†’ 6ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰ã«é›†ç´„ â”€â”€
    for (let i = 0; i < octaveDefs.length; i++) {
        const group = octaveDefs[i];
        const values = group.indices
            .map(idx => thirdResults[idx])
            .filter(v => v !== null && v > 0);

        if (values.length > 0) {
            // æœ‰åŠ¹ãª1/3octãƒãƒ³ãƒ‰ã®å¹³å‡ã‚’ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰å€¤ã¨ã™ã‚‹
            octaveResults[i] = values.reduce((sum, val) => sum + val, 0) / values.length;
            validOctaveCount++;
        } else {
            // 3æœ¬ã™ã¹ã¦null â†’ ã“ã®ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰ã¯æ¬ æ
            missingBands.push(group.label);
        }
    }

    // â”€â”€ æœ‰åŠ¹ãƒãƒ³ãƒ‰æ•°åˆ¤å®šï¼ˆ4ãƒãƒ³ãƒ‰ä¿è¨¼ï¼‰ â”€â”€
    if (validOctaveCount < 4) {
        statusEl.textContent = 'âŒ æ¸¬å®šå¤±æ•—: æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿ä¸è¶³';
        statusEl.className = 'status-msg error';

        const reasonText =
            `æ¸¬å®šã•ã‚ŒãŸæœ‰åŠ¹ãƒãƒ³ãƒ‰æ•°: ${validOctaveCount} / 6\n` +
            `æœ€ä½4ãƒãƒ³ãƒ‰ãŒå¿…è¦ã§ã™ãŒã€é”æˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\n` +
            `æ¬ æãƒãƒ³ãƒ‰: ${missingBands.join(', ')}\n\n` +
            `æ”¹å–„ç­–:\n` +
            `ãƒ»ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼éŸ³é‡ã‚’ä¸Šã’ã¦ãã ã•ã„\n` +
            `ãƒ»ç’°å¢ƒãƒã‚¤ã‚ºã‚’ä¸‹ã’ã¦ãã ã•ã„\n` +
            `ãƒ»ä½åŸŸãŒå‡ºãªã„ã‚¹ãƒãƒ›ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã®å ´åˆã¯å¤–éƒ¨ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ä½¿ç”¨ã‚’æ¨å¥¨`;

        document.getElementById('warningReason').textContent = reasonText;
        warnEl.style.display = 'block';
        return;
    }

    // â”€â”€ æ¸¬å®šæˆåŠŸ: measurementDataã«æ ¼ç´ã—ã¦calculate()å®Ÿè¡Œ â”€â”€
    measurementData = octaveResults;

    statusEl.textContent = 
        \`âœ… æ¸¬å®šå®Œäº† (æœ‰åŠ¹ãƒãƒ³ãƒ‰: \${validOctaveCount}/6)\` +
        (missingBands.length > 0 ? \` âš ï¸ æ¬ æ: \${missingBands.join(', ')}\` : '');
    statusEl.className = 'status-msg success';

    // æ¬ æãŒã‚ã‚‹å ´åˆã¯è­¦å‘Šè¡¨ç¤ºï¼ˆãŸã ã—ç¶šè¡Œï¼‰
    if (missingBands.length > 0 && missingBands.length <= 2) {
        const reasonText =
            \`ä¸€éƒ¨ã®ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\` +
            \`æ¬ æãƒãƒ³ãƒ‰: \${missingBands.join(', ')}\n\n\` +
            \`è¨ˆç®—ã¯ç¶™ç¶šã—ã¾ã™ãŒã€ç²¾åº¦ãŒä½ä¸‹ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\` +
            (missingBands.includes('125Hz') ? 
                \`\n\nâ€» ä½åŸŸ(125Hz)ãŒæ¬ æã—ã¦ã„ã¾ã™ã€‚ã‚¹ãƒãƒ›ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã®å ´åˆã¯ä»•æ§˜ã§ã™ã€‚\` : '');
        
        document.getElementById('warningReason').textContent = reasonText;
        warnEl.style.display = 'block';
    } else {
        warnEl.style.display = 'none';
    }

    // Eyringãƒ¢ãƒ¼ãƒ‰ã§calculate()ã‚’å®Ÿè¡Œ
    calculate();
}

function handleMeasurementError(message) {
    const statusEl = document.getElementById('measureStatus');
    document.getElementById('startMeasBtn').disabled = false;
    document.getElementById('measureProgress').style.display = 'none';
    document.getElementById('recordingAlert').classList.remove('active');
    statusEl.textContent = 'âŒ ' + message;
    statusEl.className = 'status-msg error';
}

window.addEventListener('DOMContentLoaded', function() { initWorker(); });
</script>

<script>
// ========================================
// æ¸¬å®šè¨­å®šï¼ˆRev 18.0 Stepped Sweepä»•æ§˜ï¼‰
// ========================================
const MEASUREMENT_CONFIG = {

    // ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆè¦æ±‚å€¤ï¼ˆ48kHzå›ºå®šï¼‰
    // AudioContextä½œæˆå¾Œã«å®Ÿæ¸¬å€¤ã¨ç…§åˆã—ã€ä¸ä¸€è‡´ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    sampleRate: 48000,

    // æ¸¬å®šãƒãƒ³ãƒ‰: 1/3ã‚ªã‚¯ã‚¿ãƒ¼ãƒ– 18ãƒãƒ³ãƒ‰ï¼ˆISO 266:2003æº–æ‹ ï¼‰
    // 3ãƒãƒ³ãƒ‰ãšã¤ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦6ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰ã«é›†ç´„ã™ã‚‹
    bands: [
        100, 125, 160,   // â†’ 125Hz ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰
        200, 250, 315,   // â†’ 250Hz
        400, 500, 630,   // â†’ 500Hz
        800, 1000, 1250, // â†’ 1kHz
        1600, 2000, 2500,// â†’ 2kHz
        3150, 4000, 5000 // â†’ 4kHz
    ],

    // ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰é›†ç´„ã‚°ãƒ«ãƒ¼ãƒ—
    // indices ã¯ä¸Šè¨˜ bands é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¯¾å¿œ
    octaveBands: [
        { label: '125Hz', indices: [0, 1, 2]   },
        { label: '250Hz', indices: [3, 4, 5]   },
        { label: '500Hz', indices: [6, 7, 8]   },
        { label: '1kHz',  indices: [9, 10, 11] },
        { label: '2kHz',  indices: [12, 13, 14]},
        { label: '4kHz',  indices: [15, 16, 17]}
    ],

    // ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­å®šï¼ˆ1ãƒãƒ³ãƒ‰ã‚ãŸã‚Š / å˜ä½: ç§’ï¼‰
    // åˆè¨ˆ: 0.5 + 1.5 + 2.0 = 4.0ç§’/ãƒãƒ³ãƒ‰ Ã— 18ãƒãƒ³ãƒ‰ = 72ç§’
    timing: {
        delay:         0.5,  // Bluetoothãƒ»ãƒ‡ãƒã‚¤ã‚¹å®‰å®šåŒ–å¾…æ©Ÿ
        stimulus:      1.5,  // å¸¯åŸŸé™å®š Log-Sweep å†ç”Ÿ
        recording:     2.0,  // æ®‹éŸ¿æ¸›è¡°éŒ²éŸ³
        totalPerBand:  4.0   // åˆè¨ˆï¼ˆå‚ç…§ç”¨ï¼‰
    },

    // è§£æãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    analysis: {
        bpfOrder:  6,     // Butterworth BPF æ¬¡æ•°ï¼ˆ36dB/octï¼‰
        bpfMargin: 0.05,  // ã‚«ãƒƒãƒˆã‚ªãƒ•ã‚’è¦æ ¼ã‚ˆã‚Š5%å†…å´ã«è¨­å®šï¼ˆéš£æ¥å¸¯åŸŸæ¼ã‚Œé˜²æ­¢ï¼‰
        minSnr:    15.0   // æ¡ç”¨æœ€ä½SNR [dB]ã€‚æœªæº€ã¯nullï¼ˆBæ¡ˆ: æ¬ ææ‰±ã„ï¼‰
    },

    // æ¸¬å®šé–‹å§‹ã‚¢ãƒŠã‚¦ãƒ³ã‚¹BeepéŸ³
    beep: {
        frequency:  1000, // Hz
        duration:   0.2,  // ç§’
        gain:       0.3,  // éŸ³é‡
        waitAfter:  1.0   // Beepå¾Œã®æº–å‚™å¾…æ©Ÿï¼ˆç§’ï¼‰
    },

    // sweepGain: Sweepä¿¡å·ã®å‡ºåŠ›ã‚²ã‚¤ãƒ³
    sweepGain: 0.7
};

let audioContext = null;
let mediaStream = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: æŒ‡å®šãƒŸãƒªç§’å¾…æ©Ÿ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// é€²æ—UIæ›´æ–°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateProgress(bandIndex, bandHz, status) {
    const total = MEASUREMENT_CONFIG.bands.length; // 18
    const pct = Math.round((bandIndex / total) * 100);
    const remaining = Math.round((total - bandIndex) * MEASUREMENT_CONFIG.timing.totalPerBand);

    const icons = { measuring: 'ğŸ”Š', ok: 'âœ…', skip: 'âš ï¸', stopping: 'ğŸ›‘' };
    const icon = icons[status] || 'ğŸ”Š';

    document.getElementById('progressBar').style.width = pct + '%';
    document.getElementById('progressCount').textContent = bandIndex + ' / ' + total;
    document.getElementById('progressTime').textContent = 'æ®‹ã‚Šç´„ ' + remaining + ' ç§’';
    document.getElementById('progressLabel').textContent =
        icon + ' ' + bandHz + 'Hz ' + (status === 'measuring' ? 'æ¸¬å®šä¸­...' :
                                        status === 'ok'        ? 'å®Œäº†' :
                                        status === 'skip'      ? 'SNRä¸è¶³ â†’ ã‚¹ã‚­ãƒƒãƒ—' :
                                        status === 'stopping'  ? 'æ—©æœŸåœæ­¢åˆ¤å®šä¸­...' : '');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ã‚¢ãƒŠã‚¦ãƒ³ã‚¹BeepéŸ³å†ç”Ÿ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function playBeep(ctx) {
    const cfg = MEASUREMENT_CONFIG.beep;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = 'sine';
    osc.frequency.value = cfg.frequency;
    gain.gain.setValueAtTime(cfg.gain, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + cfg.duration);

    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + cfg.duration);

    await sleep((cfg.duration + cfg.waitAfter) * 1000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å¸¯åŸŸé™å®š Log-Sweep ç”Ÿæˆ
// ISO 266:2003æº–æ‹ ã‚«ãƒƒãƒˆã‚ªãƒ•ï¼ˆ5%å†…å´ï¼‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateBandSweep(centerHz, sampleRate, durationSec) {
    const margin = MEASUREMENT_CONFIG.analysis.bpfMargin;
    const fLow  = (centerHz / Math.sqrt(2)) * (1 + margin);
    const fHigh = (centerHz * Math.sqrt(2)) * (1 - margin);

    const N = Math.round(durationSec * sampleRate);
    const sweep = new Float32Array(N);
    const k = Math.log(fHigh / fLow) / durationSec;

    for (let i = 0; i < N; i++) {
        const t = i / sampleRate;
        const phase = 2 * Math.PI * fLow * (Math.exp(k * t) - 1) / k;
        sweep[i] = Math.sin(phase) * MEASUREMENT_CONFIG.sweepGain;
    }

    // å…ˆé ­ãƒ»æœ«å°¾5msãƒ•ã‚§ãƒ¼ãƒ‰ï¼ˆã‚¯ãƒªãƒƒã‚¯ãƒã‚¤ã‚ºé˜²æ­¢ï¼‰
    const fadeSamples = Math.round(0.005 * sampleRate);
    for (let i = 0; i < fadeSamples; i++) {
        const fade = i / fadeSamples;
        sweep[i] *= fade;
        sweep[N - 1 - i] *= fade;
    }

    return { sweep, fLow, fHigh };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1ãƒãƒ³ãƒ‰å†ç”Ÿãƒ»éŒ²éŸ³
// Sweepå†ç”Ÿã¨åŒæ™‚ã«éŒ²éŸ³é–‹å§‹ã€recordingç§’å¾Œã«åœæ­¢
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function playAndRecord(ctx, stream, sweepData, centerHz) {
    const cfg = MEASUREMENT_CONFIG.timing;
    const fs  = ctx.sampleRate;
    const totalSamples = Math.round((cfg.stimulus + cfg.recording) * fs);

    // ScriptProcessorã§ãƒãƒƒãƒ•ã‚¡åé›†ï¼ˆäº’æ›æ€§é‡è¦–ï¼‰
    const bufferSize = 4096;
    const recorded = new Float32Array(totalSamples);
    let recordedSamples = 0;
    let resolveRecording;
    const recordingDone = new Promise(r => { resolveRecording = r; });

    const source = ctx.createMediaStreamSource(stream);
    const processor = ctx.createScriptProcessor(bufferSize, 1, 1);

    processor.onaudioprocess = (e) => {
        const input = e.inputBuffer.getChannelData(0);
        for (let i = 0; i < input.length; i++) {
            if (recordedSamples < totalSamples) {
                recorded[recordedSamples++] = input[i];
            }
        }
        if (recordedSamples >= totalSamples) {
            resolveRecording();
        }
    };

    source.connect(processor);
    processor.connect(ctx.destination); // å¿…è¦ï¼ˆChromeã®ä»•æ§˜ï¼‰

    // Sweepå†ç”Ÿ
    const sweepBuffer = ctx.createBuffer(1, sweepData.sweep.length, fs);
    sweepBuffer.copyToChannel(sweepData.sweep, 0);
    const sweepSource = ctx.createBufferSource();
    sweepSource.buffer = sweepBuffer;
    sweepSource.connect(ctx.destination);
    sweepSource.start();

    // éŒ²éŸ³å®Œäº†ã¾ã§å¾…æ©Ÿ
    await recordingDone;

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    source.disconnect();
    processor.disconnect();
    sweepSource.stop();

    return recorded;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰å®Œäº†æ™‚ã®æ—©æœŸæ‰“ã¡åˆ‡ã‚Šåˆ¤å®š
// ç¢ºå®šå¼: validOctaves + remainingOctaves < 4 â†’ åœæ­¢
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkEarlyTermination(validOctaves, completedOctaves) {
    const remaining = 6 - completedOctaves;
    if (validOctaves + remaining < 4) {
        const msg =
            `æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿ãŒ ${validOctaves} ãƒãƒ³ãƒ‰ã®ã¿ã§ã™ã€‚\n` +
            `æ®‹ã‚Š ${remaining} ãƒãƒ³ãƒ‰ã‚’æ¸¬å®šã—ã¦ã‚‚4ãƒãƒ³ãƒ‰ã®ç¢ºä¿ãŒä¸å¯èƒ½ãªãŸã‚åœæ­¢ã—ã¾ã—ãŸã€‚\n` +
            `ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼éŸ³é‡ã‚’ä¸Šã’ã‚‹ã‹ã€ç’°å¢ƒãƒã‚¤ã‚ºã‚’ä¸‹ã’ã¦å†æ¸¬å®šã—ã¦ãã ã•ã„ã€‚`;
        return { stop: true, reason: msg };
    }
    return { stop: false };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒ¡ã‚¤ãƒ³æ¸¬å®šã‚·ãƒ¼ã‚±ãƒ³ã‚¹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runMeasurementSequence() {
    const statusEl  = document.getElementById('measureStatus');
    const startBtn  = document.getElementById('startMeasBtn');
    const progressEl = document.getElementById('measureProgress');

    startBtn.disabled = true;
    document.getElementById('remeasureWarning').style.display = 'none';

    // é€²æ—ãƒãƒ¼åˆæœŸåŒ–
    progressEl.style.display = 'block';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressCount').textContent = '0 / 18';
    document.getElementById('progressTime').textContent = 'æ®‹ã‚Šç´„ 72 ç§’';
    document.getElementById('progressLabel').textContent = 'æº–å‚™ä¸­...';

    // â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¸0: AudioContext ä½œæˆãƒ»ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆç¢ºèª â”€â”€
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)({
            sampleRate: MEASUREMENT_CONFIG.sampleRate
        });

        const actualFs = audioContext.sampleRate;
        if (actualFs !== MEASUREMENT_CONFIG.sampleRate) {
            throw new Error(
                `ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯48kHzã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\n` +
                `ï¼ˆæ¤œå‡ºå€¤: ${actualFs}Hzï¼‰\n` +
                `ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼/ãƒã‚¤ã‚¯ã®è¨­å®šã‚’ç¢ºèªã™ã‚‹ã‹ã€åˆ¥ã®ãƒ‡ãƒã‚¤ã‚¹ã§æ¸¬å®šã—ã¦ãã ã•ã„ã€‚`
            );
        }
    } catch (err) {
        statusEl.textContent = 'âŒ ' + err.message;
        statusEl.className = 'status-msg error';
        startBtn.disabled = false;
        progressEl.style.display = 'none';
        return;
    }

    // â”€â”€ Workerã¸INITé€ä¿¡ï¼ˆsampleRateãƒ»configä¸€æ‹¬é€šçŸ¥ï¼‰ â”€â”€
    measurementWorker.postMessage({
        type:       'INIT',
        sampleRate: audioContext.sampleRate,
        config:     MEASUREMENT_CONFIG
    });

    // â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¸0: ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾— â”€â”€
    try {
        const micId = document.getElementById('micSelect').value;
        const constraints = {
            audio: {
                deviceId: micId ? { exact: micId } : undefined,
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false,
                sampleRate: MEASUREMENT_CONFIG.sampleRate
            }
        };
        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
    } catch (err) {
        statusEl.textContent = 'âŒ ãƒã‚¤ã‚¯ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
        statusEl.className = 'status-msg error';
        startBtn.disabled = false;
        progressEl.style.display = 'none';
        return;
    }

    // â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¸1: ã‚¢ãƒŠã‚¦ãƒ³ã‚¹Beep + æ¸¬å®šé–‹å§‹é€šçŸ¥ â”€â”€
    statusEl.textContent = 'ğŸ”” æ¸¬å®šã‚’é–‹å§‹ã—ã¾ã™ã€‚é™ã‹ã«ã—ã¦ãã ã•ã„ï¼ˆç´„72ç§’ï¼‰';
    statusEl.className = 'status-msg calibrating';
    document.getElementById('recordingAlert').classList.add('active');

    try {
        await playBeep(audioContext);
    } catch (err) {
        // Beepå¤±æ•—ã¯éè‡´å‘½çš„ â†’ ç¶šè¡Œ
        console.warn('Beepå†ç”Ÿå¤±æ•—ï¼ˆç¶šè¡Œï¼‰:', err.message);
    }

    // â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¸2: 18ãƒãƒ³ãƒ‰é€æ¬¡æ¸¬å®š â”€â”€
    const bands       = MEASUREMENT_CONFIG.bands;       // 18æœ¬
    const octaveDefs  = MEASUREMENT_CONFIG.octaveBands; // 6ã‚°ãƒ«ãƒ¼ãƒ—
    const thirdResults = new Array(18).fill(null);       // 1/3octåˆ¥RT60

    let validOctaveCount   = 0;  // æˆåŠŸã—ãŸã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰æ•°
    let completedOctaves   = 0;  // å®Œäº†ã—ãŸã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰æ•°
    let earlyStop          = false;
    let earlyStopReason    = '';

    for (let bi = 0; bi < bands.length; bi++) {
        const centerHz = bands[bi];

        // é€²æ—UIæ›´æ–°ï¼ˆæ¸¬å®šä¸­ï¼‰
        updateProgress(bi, centerHz, 'measuring');
        statusEl.textContent = `ğŸ”Š ${centerHz}Hz æ¸¬å®šä¸­... [${bi + 1}/18]`;
        statusEl.className = 'status-msg analyzing';

        // delay: Bluetooth/ãƒ‡ãƒã‚¤ã‚¹å®‰å®šåŒ–å¾…æ©Ÿ
        await sleep(MEASUREMENT_CONFIG.timing.delay * 1000);

        // Sweepç”Ÿæˆ
        const sweepData = generateBandSweep(
            centerHz,
            audioContext.sampleRate,
            MEASUREMENT_CONFIG.timing.stimulus
        );

        // å†ç”Ÿãƒ»éŒ²éŸ³
        let recorded;
        try {
            recorded = await playAndRecord(
                audioContext, mediaStream, sweepData, centerHz
            );
        } catch (err) {
            console.warn(`${centerHz}Hz éŒ²éŸ³å¤±æ•—:`, err.message);
            updateProgress(bi + 1, centerHz, 'skip');
            thirdResults[bi] = null;
            // ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰å¢ƒç•Œãƒã‚§ãƒƒã‚¯ï¼ˆã“ã®ãƒãƒ³ãƒ‰ãŒæœ€çµ‚1/3octãªã‚‰ï¼‰
            const octIdx = Math.floor(bi / 3);
            if ((bi + 1) % 3 === 0) {
                completedOctaves++;
                // ç¾ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰ã®æœ‰åŠ¹æ•°ç¢ºèª
                const g = octaveDefs[octIdx].indices;
                const octValid = g.filter(i => thirdResults[i] !== null).length;
                if (octValid > 0) validOctaveCount++;
                const check = checkEarlyTermination(validOctaveCount, completedOctaves);
                if (check.stop) {
                    earlyStop = true;
                    earlyStopReason = check.reason;
                    break;
                }
            }
            continue;
        }

        // Workerã«RawéŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ + Sweepæƒ…å ±ã‚’é€ä¿¡ã—ã¦è§£æ
        const workerResult = await new Promise((resolve) => {
            measurementWorker.onmessage = (e) => {
                if (e.data.type === 'bandResult') resolve(e.data);
            };
            measurementWorker.postMessage({
                type:     'ANALYZE_BAND',
                band:     centerHz,
                recorded: recorded.buffer,
                sweep:    sweepData.sweep.buffer
            }, [recorded.buffer, sweepData.sweep.buffer]); // Transferable
        });

        if (workerResult.type === 'bandResult' && workerResult.rt60 !== null) {
            thirdResults[bi] = workerResult.rt60;
            updateProgress(bi + 1, centerHz, 'ok');
        } else {
            thirdResults[bi] = null;
            updateProgress(bi + 1, centerHz, 'skip');
            const reason = workerResult.reason || 'SNRä¸è¶³';
            console.info(`${centerHz}Hz ã‚¹ã‚­ãƒƒãƒ—: ${reason}`);
        }

        // â”€â”€ ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ãƒãƒ³ãƒ‰å¢ƒç•Œãƒã‚§ãƒƒã‚¯ï¼ˆ3ãƒãƒ³ãƒ‰æ¯ï¼‰ â”€â”€
        if ((bi + 1) % 3 === 0) {
            completedOctaves++;
            const octIdx = completedOctaves - 1;
            const g = octaveDefs[octIdx].indices;
            const octValid = g.filter(i => thirdResults[i] !== null).length;
            if (octValid > 0) validOctaveCount++;

            const check = checkEarlyTermination(validOctaveCount, completedOctaves);
            if (check.stop) {
                earlyStop = true;
                earlyStopReason = check.reason;
                updateProgress(bi + 1, centerHz, 'stopping');
                break;
            }
        }
    }

    // â”€â”€ éŒ²éŸ³åœæ­¢ãƒ»ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— â”€â”€
    document.getElementById('recordingAlert').classList.remove('active');
    if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
    }
    if (audioContext) {
        try { await audioContext.close(); } catch(e) {}
        audioContext = null;
    }

    // â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¸3: æ—©æœŸåœæ­¢ã®å ´åˆ â”€â”€
    if (earlyStop) {
        statusEl.textContent = 'ğŸ›‘ æ¸¬å®šã‚’æ—©æœŸåœæ­¢ã—ã¾ã—ãŸ';
        statusEl.className = 'status-msg error';
        const warnEl = document.getElementById('remeasureWarning');
        document.getElementById('warningReason').textContent = earlyStopReason;
        warnEl.style.display = 'block';
        startBtn.disabled = false;
        progressEl.style.display = 'none';
        return;
    }

    // â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¸3: å…¨ãƒãƒ³ãƒ‰å®Œäº† â†’ handleMeasurementResult ã¸ â”€â”€
    handleMeasurementResult({ type: 'result', thirdResults });
}
</script>

<script>
// ========================================
// Google Form é€ä¿¡ãƒ»ã‚°ãƒ©ãƒ•æç”»ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰
// ========================================
function sendToGoogleForm() {
    const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSedr8Z99dcRJuV3qYRmYddUUzYGrnvrz2aU3zbFvrwVpbTreQ/viewform";
    const appSelect = document.getElementById('appTarget');
    const app = appSelect.options[appSelect.selectedIndex].text;
    const w = document.getElementById('w').value;
    const d = document.getElementById('d').value;
    const h = document.getElementById('h').value;
    const size = `${w}m Ã— ${d}m Ã— ${h}m`;
    const wallSelect = document.getElementById('baseWall');
    const ceilingSelect = document.getElementById('baseCeiling');
    const floorSelect = document.getElementById('baseFloor');
    const base = `å£: ${wallSelect.options[wallSelect.selectedIndex].text}, å¤©äº•: ${ceilingSelect.options[ceilingSelect.selectedIndex].text}, åºŠ: ${floorSelect.options[floorSelect.selectedIndex].text}`;
    let productList = "";
    for (let i = 0; i < 3; i++) {
        const spec = selectedSpecs[i];
        const qty = parseInt(document.getElementById(`qty_${i}`).value) || 0;
        if (spec.category && spec.model && spec.thick && spec.size && qty > 0) {
            productList += `ãƒ»${SOUNDBOX_DB.products[spec.category].models[spec.model].n} / ${spec.thick}mm / ${spec.size} Ã— ${qty}æš\n`;
        }
    }
    if (!productList) productList = "é¸æŠãªã—";
    const rtText = document.getElementById('postRT_Avg').textContent;
    const params = new URLSearchParams();
    params.append("usp", "pp_url");
    params.append("entry.1871431492", app);
    params.append("entry.1902994140", size);
    params.append("entry.779901469", base);
    params.append("entry.364281805", productList);
    params.append("entry.1449240528", rtText);
    window.open(`${formUrl}?${params.toString()}`, '_blank');
}

function updateChart(rt_before, rt_after, targetRT) {
    const ctx = document.getElementById('rtChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: FREQS.map(f => f + 'Hz'),
            datasets: [
                { label: 'ç¾çŠ¶ (Before)', data: rt_before, borderColor: '#8b949e', backgroundColor: 'rgba(139, 148, 158, 0.05)', borderDash: [5, 5], borderWidth: 2, fill: false, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#8b949e' },
                { label: 'å¯¾ç­–å¾Œ (After)', data: rt_after, borderColor: '#39d353', backgroundColor: 'rgba(57, 211, 83, 0.1)', borderWidth: 3, fill: true, tension: 0.3, pointRadius: 5, pointBackgroundColor: '#39d353', pointBorderColor: '#fff', pointBorderWidth: 2 },
                { label: 'ç›®æ¨™å€¤', data: FREQS.map(() => targetRT), borderColor: '#388bfd', backgroundColor: 'rgba(56, 139, 253, 0.05)', borderWidth: 2, borderDash: [10, 5], fill: false, pointRadius: 0 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                y: { min: 0, max: 2.5, grid: { color: '#30363d', lineWidth: 1 }, ticks: { color: '#8b949e', font: { size: 11 }, callback: v => v.toFixed(1) + 's' }, title: { display: true, text: 'RT60 (sec)', color: '#8b949e', font: { size: 12, weight: 'bold' } } },
                x: { grid: { color: '#30363d', lineWidth: 1 }, ticks: { color: '#8b949e', font: { size: 11 } } }
            },
            plugins: {
                legend: { display: true, position: 'top', labels: { color: '#e6edf3', font: { size: 11 }, padding: 15, usePointStyle: true } },
                tooltip: { backgroundColor: 'rgba(22, 27, 34, 0.95)', titleColor: '#e6edf3', bodyColor: '#e6edf3', borderColor: '#30363d', borderWidth: 1, padding: 10, callbacks: { label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + 's' } }
            }
        }
    });
}
</script>

</body>
</html>