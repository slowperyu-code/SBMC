<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <link rel="canonical" href="https://soundbox.altwaves.co.jp/">
    <meta name="description" content="Soundbox Engine v6.1 (Rev 17.5): Sabine-Eyring Hybrid Professional System with Real-time Measurement">
    <title>Soundbox Material Calculator v7 | ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«èª¿éŸ³è¨­è¨ˆãƒ„ãƒ¼ãƒ«</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #39d353; 
            --bg: #0d1117; 
            --card: #161b22; 
            --text: #e6edf3; 
            --dim: #8b949e; 
            --border: #30363d; 
            --accent: #388bfd; 
            --danger: #ff7b72; 
            --warning: #d29922; 
            --success: #39d353; 
            --caution: #f0883e;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            padding: 15px; 
            margin: 0; 
            font-size: 13px; 
            line-height: 1.4; 
        }
        
        .container { 
            max-width: 1000px; 
            min-width: 800px; 
            margin: auto; 
            background: var(--card); 
            padding: 25px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
            position: relative; 
        }
        
        .header { 
            border-bottom: 1px solid var(--border); 
            margin-bottom: 20px; 
            padding-bottom: 12px; 
            position: relative; 
        }
        
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
        }
        
        h2 { 
            color: var(--primary); 
            margin: 0; 
            font-size: 1.4rem; 
            letter-spacing: 0.5px; 
        }
        
        .subtitle { 
            font-size: 0.85rem; 
            color: var(--text); 
            margin-top: 5px; 
            font-weight: 500; 
        }
        
        .logic-note { 
            position: absolute; 
            bottom: 8px; 
            right: 0; 
            font-size: 0.65rem; 
            color: var(--dim); 
            font-style: italic; 
        }
        
        .btn-group { 
            display: flex; 
            gap: 10px; 
        }
        
        .btn-base { 
            border: none; 
            padding: 7px 16px; 
            border-radius: 4px; 
            font-size: 0.75rem; 
            cursor: pointer; 
            font-weight: bold; 
            transition: opacity 0.2s; 
            text-decoration: none; 
        }
        
        .btn-print { 
            background: var(--border); 
            color: var(--text); 
            border: 1px solid var(--border); 
        }
        
        .btn-estimate { 
            background: var(--accent); 
            color: white; 
        }
        
        .btn-base:hover { 
            opacity: 0.8; 
        }

        .section-title { 
            font-size: 0.8rem; 
            font-weight: bold; 
            color: var(--accent); 
            margin: 20px 0 10px 0; 
            border-left: 3px solid var(--accent); 
            padding-left: 8px; 
        }
        
        input, select, .custom-select-trigger { 
            background: var(--bg); 
            border: 1px solid var(--border); 
            color: var(--text); 
            padding: 0 10px; 
            border-radius: 4px; 
            width: 100%; 
            box-sizing: border-box; 
            font-size: 0.75rem; 
            height: 36px; 
            line-height: 34px; 
            display: flex; 
            align-items: center; 
        }
        
        .grid-3 { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-bottom: 10px; 
        }
        
        .grid-row { 
            display: grid; 
            grid-template-columns: 2fr 3.5fr 0.8fr 0.8fr 1fr; 
            gap: 8px; 
            margin-bottom: 8px; 
            align-items: end; 
        }
        
        label { 
            font-size: 0.65rem; 
            color: var(--dim); 
            margin-bottom: 4px; 
            display: block; 
        }
        
        .custom-select-container { 
            position: relative; 
            width: 100%; 
        }
        
        .custom-select-trigger { 
            cursor: pointer; 
            overflow: hidden; 
            white-space: nowrap; 
            text-overflow: ellipsis; 
            border: 1px solid var(--border); 
        }
        
        .sub-panel { 
            display: none; 
            position: absolute; 
            top: 100%; 
            left: 0; 
            width: 540px; 
            background: #1c2128; 
            border: 1px solid var(--accent); 
            border-radius: 8px; 
            z-index: 100; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); 
            padding: 15px; 
            margin-top: 5px; 
        }
        
        .sub-panel.active { 
            display: block; 
        }
        
        .panel-cols { 
            display: grid; 
            grid-template-columns: 1.4fr 0.8fr 1.2fr; 
            gap: 12px; 
        }
        
        .col-title { 
            font-size: 0.6rem; 
            color: var(--accent); 
            margin-bottom: 8px; 
            font-weight: bold; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 4px; 
        }
        
        .col-item { 
            padding: 6px 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-bottom: 3px; 
            font-size: 0.7rem; 
            color: var(--text); 
        }
        
        .col-item:hover { 
            background: var(--border); 
        }
        
        .col-item.selected { 
            background: var(--accent); 
            color: white; 
            font-weight: bold; 
        }
        
        .res-panel { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            margin: 20px 0; 
        }
        
        .res-card { 
            background: var(--bg); 
            padding: 15px; 
            border-radius: 10px; 
            border: 2px solid var(--border); 
            text-align: center; 
        }
        
        .res-val { 
            font-size: 1.6rem; 
            font-weight: bold; 
            font-family: "Roboto Mono", monospace; 
        }
        
        .chart-wrapper { 
            position: relative; 
            height: 320px; 
            margin-top: 10px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 10px; 
            background: rgba(0,0,0,0.2); 
        }
        
        .footer-note { 
            margin-top: 20px; 
            padding: 18px; 
            background: rgba(56, 139, 253, 0.05); 
            border-radius: 8px; 
            border: 1px solid var(--border); 
        }
        
        .advice-tag { 
            display: inline-block; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-weight: bold; 
            margin-bottom: 8px; 
            font-size: 0.7rem; 
            color: #000; 
        }
        
        #print-only-notice { 
            display: none; 
            margin-top: 30px; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 0.75rem; 
            line-height: 1.6; 
            color: #333; 
        }

        .mode-switcher { 
            display: flex; 
            background: var(--bg); 
            padding: 4px; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            margin-bottom: 20px; 
        }
        
        .mode-btn { 
            flex: 1; 
            padding: 10px; 
            border: none; 
            background: transparent; 
            color: var(--dim); 
            cursor: pointer; 
            border-radius: 6px; 
            font-weight: bold; 
            transition: 0.2s; 
            font-size: 0.75rem; 
        }
        
        .mode-btn.active { 
            background: var(--accent); 
            color: white; 
        }
        
        .mode-btn.active.measure { 
            background: var(--warning); 
            color: #000; 
        }
        
        .calc-badge { 
            display: inline-block; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.6rem; 
            font-weight: bold; 
            margin-left: 5px;
            background: var(--accent); 
            color: white;
        }
        
        .measurement-panel { 
            background: rgba(56, 139, 253, 0.05); 
            border: 1px solid var(--accent); 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px; 
        }
        
        .measure-controls { 
            display: grid; 
            grid-template-columns: 1fr 1fr auto; 
            gap: 10px; 
            align-items: end; 
        }
        
        .status-msg { 
            font-size: 0.75rem; 
            margin-top: 10px; 
            font-weight: 500; 
            min-height: 1.2em;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .status-msg.ready { 
            color: var(--dim); 
        }
        
        .status-msg.calibrating { 
            background: rgba(210, 153, 34, 0.1);
            color: var(--warning); 
        }
        
        .status-msg.analyzing { 
            background: rgba(56, 139, 253, 0.1);
            color: var(--accent); 
        }
        
        .status-msg.success { 
            background: rgba(57, 211, 83, 0.1);
            color: var(--success); 
        }
        
        .status-msg.error { 
            background: rgba(255, 123, 114, 0.1);
            color: var(--danger); 
        }
        
        .recording-flash { 
            display: none;
            background: rgba(255, 123, 114, 0.1); 
            border: 2px solid var(--danger); 
            border-radius: 8px; 
            padding: 15px; 
            margin-top: 10px;
            text-align: center;
        }
        
        .recording-flash.active { 
            display: block; 
            animation: flash-border 1s infinite; 
        }
        
        .flash-icon { 
            font-size: 2rem; 
            animation: blink 1s infinite; 
        }
        
        .flash-text { 
            font-size: 0.9rem; 
            font-weight: bold; 
            color: var(--danger); 
            margin-top: 8px;
        }
        
        @keyframes blink { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.3; } 
        }
        
        @keyframes flash-border { 
            0%, 100% { border-color: var(--danger); } 
            50% { border-color: rgba(255, 123, 114, 0.3); } 
        }
        
        .snr-indicator { 
            margin-top: 10px; 
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }
        
        .snr-bar { 
            position: relative;
            width: 100%; 
            height: 20px; 
            background: var(--border); 
            border-radius: 10px; 
            overflow: hidden;
            margin-top: 5px;
        }
        
        .snr-value { 
            height: 100%; 
            background: linear-gradient(90deg, var(--danger), var(--warning), var(--success)); 
            transition: width 0.3s; 
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
        }
        
        .warning-box { 
            background: rgba(255, 123, 114, 0.1); 
            border: 1px solid var(--danger); 
            border-radius: 6px; 
            padding: 12px; 
            margin-top: 10px;
            font-size: 0.75rem;
        }
        
        .warning-box button { 
            margin-top: 8px; 
            padding: 6px 12px; 
            background: var(--danger); 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .warning-box button:hover { 
            opacity: 0.8; 
        }
        
        #warning-reason { 
            margin-top: 5px; 
            font-size: 0.7rem; 
            color: var(--dim);
        }

        @media print {
            @page { size: A4; margin: 15mm; }
            body { background: white !important; color: black !important; padding: 0; }
            .container { box-shadow: none !important; border: none !important; width: 100% !important; max-width: none !important; min-width: 0 !important; background: white !important; padding: 0 !important; }
            .no-print, .logic-note, .mode-switcher, .measurement-panel { display: none !important; }
            .header { border-bottom: 2pt solid black !important; }
            h2, .section-title, .res-val, .subtitle { color: black !important; }
            input, select, .custom-select-trigger { border: none !important; background: transparent !important; color: black !important; padding: 0 !important; height: auto !important; appearance: none; }
            .grid-row { border-bottom: 0.5pt solid #eee; padding-bottom: 5px; }
            .res-card { border: 1pt solid black !important; background: white !important; }
            .chart-wrapper { border: 1pt solid #ccc !important; background: white !important; height: 300px !important; }
            .footer-note { border: 1pt solid #ccc !important; background: #f9f9f9 !important; color: black !important; }
            #print-only-notice { display: block !important; border: none !important; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-top">
            <h2>Soundbox Material Calculator</h2>
            <div class="btn-group no-print">
                <button class="btn-base btn-print" onclick="prepareForPrint()">çµæœã‚’å°åˆ· / PDFä¿å­˜</button>
                <button class="btn-base btn-estimate" onclick="sendToGoogleForm()">ã“ã®å†…å®¹ã§è¦‹ç©ã‚‚ã‚Šä¾é ¼</button>
            </div>
        </div>
        <div class="subtitle">Soundbox Engine v6.1 (Rev 17.5): Sabine-Eyring Hybrid System with Real-time Measurement</div>
        <div class="logic-note">Hybrid Calculation Engine Active</div>
    </div>

    <div class="mode-switcher no-print">
        <button class="mode-btn active" id="btnSim" onclick="setMode('sim')">è¨­è¨ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (Sabine)</button>
        <button class="mode-btn" id="btnMeasure" onclick="setMode('measure')">å®Ÿæ¸¬å€¤ãƒ™ãƒ¼ã‚¹æ”¹å–„ (Eyring)</button>
    </div>

    <div id="measurementPanel" class="measurement-panel no-print" style="display:none;">
        <div style="font-size:0.8rem; font-weight:bold; color:var(--accent); margin-bottom:12px;">
            ğŸ¤ PRO æ¸¬å®šãƒ¢ãƒ¼ãƒ‰ (Eyring Method / Log-Sweep Analysis)
        </div>
        
        <div class="measure-controls">
            <div>
                <label>å…¥åŠ›ãƒ‡ãƒã‚¤ã‚¹ (ãƒã‚¤ã‚¯)</label>
                <select id="micSelect">
                    <option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>
                </select>
            </div>
            <div>
                <label>å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹ (ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼)</label>
                <select id="spkSelect">
                    <option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>
                </select>
            </div>
            <button class="btn-base btn-estimate" id="startMeasBtn" onclick="runMeasurementSequence()">
                æ¸¬å®šé–‹å§‹
            </button>
        </div>
        
        <div id="measureStatus" class="status-msg ready">Ready - ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠã—ã¦æ¸¬å®šé–‹å§‹ã—ã¦ãã ã•ã„</div>
        
        <div id="snrIndicator" class="snr-indicator" style="display:none;">
            <label style="font-size:0.7rem; color:var(--dim);">ä¿¡å·å¯¾é›‘éŸ³æ¯” (S/N Ratio)</label>
            <div class="snr-bar">
                <div id="snrValue" class="snr-value" style="width:0%;"></div>
            </div>
        </div>
        
        <div id="recordingAlert" class="recording-flash">
            <div class="flash-icon">ğŸ”´</div>
            <div class="flash-text">ğŸ“¢ æ¸¬å®šä¸­ã§ã™ - é™ã‹ã«ã—ã¦ãã ã•ã„</div>
        </div>
        
        <div id="remeasureWarning" class="warning-box" style="display:none;">
            <strong>âš ï¸ ãƒ‡ãƒ¼ã‚¿å“è³ªãŒä¸è¶³ã—ã¦ã„ã¾ã™</strong>
            <div id="warningReason"></div>
            <button onclick="runMeasurementSequence()">å†æ¸¬å®šã‚’å®Ÿè¡Œ</button>
        </div>
        
        <div id="manualInputPanel" style="display:none; margin-top:15px; padding:12px; background:rgba(0,0,0,0.2); border-radius:6px;">
            <label style="font-size:0.7rem; color:var(--warning); font-weight:bold;">
                æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¸¬å®šå€¤ã‚’ç›´æ¥å…¥åŠ›ï¼‰
            </label>
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-top: 8px;">
                <div>
                    <label>125Hz</label>
                    <input type="number" id="m125" value="0.80" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()">
                </div>
                <div>
                    <label>250Hz</label>
                    <input type="number" id="m250" value="0.70" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()">
                </div>
                <div>
                    <label>500Hz</label>
                    <input type="number" id="m500" value="0.60" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()">
                </div>
                <div>
                    <label>1kHz</label>
                    <input type="number" id="m1k" value="0.60" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()">
                </div>
                <div>
                    <label>2kHz</label>
                    <input type="number" id="m2k" value="0.50" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()">
                </div>
                <div>
                    <label>4kHz</label>
                    <input type="number" id="m4k" value="0.50" step="0.01" style="height:28px; font-size:0.7rem; text-align:center;" oninput="calculate()">
                </div>
            </div>
            <div style="font-size:0.65rem; color:var(--dim); margin-top:8px;">
                â€» è‡ªå‹•æ¸¬å®šãŒåˆ©ç”¨ã§ããªã„å ´åˆã€å¤–éƒ¨æ¸¬å®šå™¨ã§å–å¾—ã—ãŸæ®‹éŸ¿æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
            </div>
        </div>
    </div>

    <div class="section-title">1. åŸºæœ¬ç’°å¢ƒè¨­å®š</div>
    <div class="grid-3">
        <div>
            <label>åˆ©ç”¨ç›®çš„ (ç›®æ¨™å€¤)</label>
            <select id="appTarget"></select>
        </div>
        <div>
            <label>éƒ¨å±‹ã‚µã‚¤ã‚º W / D / H [m]</label>
            <div style="display:flex; gap:4px;">
                <input type="number" id="w" value="4.0" step="0.1">
                <input type="number" id="d" value="6.0" step="0.1">
                <input type="number" id="h" value="2.6" step="0.1">
            </div>
        </div>
        <div>
            <label>å£é¢ä»•ä¸Šã’ (ãƒ™ãƒ¼ã‚¹)</label>
            <select id="baseWall"></select>
        </div>
    </div>
    <div class="grid-3">
        <div>
            <label>å¤©äº•ä»•ä¸Šã’</label>
            <select id="baseCeiling"></select>
        </div>
        <div>
            <label>åºŠä»•ä¸Šã’</label>
            <select id="baseFloor"></select>
        </div>
        <div style="display:flex; align-items:flex-end; padding-bottom:5px;">
            <input type="checkbox" id="showSpecial" style="width:16px; margin-right:8px;">
            <label for="showSpecial" style="margin:0; cursor:pointer; color:var(--accent);">
                é–‹å£éƒ¨(çª“ç­‰)ã‚’è€ƒæ…®ã™ã‚‹
            </label>
        </div>
    </div>

    <div id="specialPanel" style="display:none; background: rgba(56, 139, 253, 0.05); padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px dashed var(--accent);">
        <div class="grid-3" style="grid-template-columns: 2fr 1fr 1fr;">
            <div>
                <label>è¿½åŠ ç´ æ</label>
                <select id="exMat"></select>
            </div>
            <div>
                <label>é¢ç© [ã¡]</label>
                <input type="number" id="exArea" value="2.0" step="0.1">
            </div>
        </div>
    </div>

    <div class="section-title">2. è£½å“ã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</div>
    <div id="sbInputs"></div>

    <div class="res-panel">
        <div class="res-card">
            <label style="font-size:0.6rem">å¹³å‡æ®‹éŸ¿æ™‚é–“ (500Hz-1kHz)</label>
            <div id="postRT_Avg" class="res-val">-</div>
            <div id="targetLabel" style="font-size:0.6rem; color:var(--dim)">ç›®æ¨™: -</div>
            <div id="calcMethod" style="font-size:0.55rem; color:var(--dim); margin-top:3px;">
                <span class="calc-badge" id="methodBadge">SABINE</span>
            </div>
        </div>
        <div class="res-card" id="cardHealth">
            <label style="font-size:0.6rem">å®Ÿç”¨æ€§è©•ä¾¡</label>
            <div id="achievementRate" class="res-val">-</div>
            <div id="healthStatus" style="font-size:0.65rem; font-weight:bold;">-</div>
        </div>
        <div class="res-card">
            <label style="font-size:0.6rem">å°å…¥é¢ç© / æ‹¡æ•£å¯„ä¸åº¦</label>
            <div id="totalPanelArea" class="res-val" style="font-size:1.1rem;">-</div>
            <div id="diffusionBalance" style="font-size:0.65rem; color:var(--primary)">-</div>
        </div>
    </div>

    <div class="chart-wrapper">
        <canvas id="rtChart"></canvas>
    </div>

    <div class="footer-note">
        <div id="adviceHeader" class="advice-tag"></div>
        <div id="detailedNote" style="font-size:0.75rem;"></div>
    </div>

    <div id="print-only-notice">
        <strong>ã€ã”æ¡ˆå†…ã€‘</strong><br>
        æœ¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã¯ã€å…¥åŠ›ã•ã‚ŒãŸæ¡ä»¶ä¸‹ã«ãŠã‘ã‚‹ã‚»ãƒ¼ãƒ“ãƒ³å¼ã«åŸºã¥ã„ãŸè¨ˆç®—ç›®å®‰ã§ã‚ã‚Šã€å®Ÿéš›ã®æ–½å·¥ç¾å ´ã®ç’°å¢ƒï¼ˆå®¶å…·ã®é…ç½®ã€ä¸‹åœ°ã®æ§‹é€ ã€æ¸©æ¹¿åº¦ç­‰ï¼‰ã«ã‚ˆã‚Šå¤‰å‹•ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
        ã‚ˆã‚Šé«˜åº¦ãªè©³ç´°è§£æã‚„ã€ãƒ‘ãƒãƒ«ã®å…·ä½“çš„ãªé…ç½®è¨ˆç”»ï¼ˆåå°„éŸ³åˆ†å¸ƒã®æœ€é©åŒ–ãªã©ï¼‰ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€<strong>AFMG EASE</strong> ã«ã‚ˆã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ã¾ãŸã¯å¼Šç¤¾å°‚é–€ã‚¹ã‚¿ãƒƒãƒ•ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
    </div>
</div>

<script>
const SOUNDBOX_DB = {
    apps: [
        { id: "office", name: "ã‚ªãƒ•ã‚£ã‚¹ / ä¸€èˆ¬ä¼šè­°å®¤ (0.6s)", t: 0.6 },
        { id: "web_mtg", name: "Webä¼šè­°å®¤ / ã‚ªãƒ³ãƒ©ã‚¤ãƒ³MTG (0.4s)", t: 0.4 },
        { id: "studio", name: "ãƒ¬ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¸ã‚ª (0.4s)", t: 0.4 },
        { id: "audio", name: "ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ«ãƒ¼ãƒ  / ãƒ›ãƒ¼ãƒ ã‚·ã‚¢ã‚¿ãƒ¼ (0.45s)", t: 0.45 },
        { id: "living", name: "ãƒªãƒ“ãƒ³ã‚° / ä¸€èˆ¬ä½å®… (0.5s)", t: 0.5 },
        { id: "broadcast", name: "é…ä¿¡ã‚¹ã‚¿ã‚¸ã‚ª / ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ (0.35s)", t: 0.35 },
        { id: "classroom", name: "æ•™å®¤ / ã‚»ãƒŸãƒŠãƒ¼ãƒ«ãƒ¼ãƒ  (0.7s)", t: 0.7 },
        { id: "hall", name: "å¤šç›®çš„ãƒ›ãƒ¼ãƒ« / ä½“è‚²é¤¨ (1.2s)", t: 1.2 }
    ],
    materials: {
        "plasterboard": { name: "çŸ³è†ãƒœãƒ¼ãƒ‰ + å£ç´™", data: [0.29, 0.10, 0.05, 0.04, 0.07, 0.09] },
        "concrete": { name: "ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆæ‰“æ”¾ã—", data: [0.01, 0.01, 0.01, 0.02, 0.02, 0.03] },
        "glass": { name: "ã‚¬ãƒ©ã‚¹çª“ / é¡", data: [0.35, 0.25, 0.18, 0.12, 0.07, 0.04] },
        "carpet": { name: "ã‚¿ã‚¤ãƒ«ã‚«ãƒ¼ãƒšãƒƒãƒˆ", data: [0.02, 0.05, 0.10, 0.20, 0.30, 0.40] },
        "wood": { name: "ãƒ•ãƒ­ãƒ¼ãƒªãƒ³ã‚° / æœ¨æ¿", data: [0.15, 0.11, 0.10, 0.07, 0.06, 0.07] },
        "curtain": { name: "ã‚«ãƒ¼ãƒ†ãƒ³ (é‡ç›®/ãƒ—ãƒªãƒ¼ãƒ„æœ‰)", data: [0.07, 0.31, 0.49, 0.75, 0.70, 0.60] },
        "gw_insulation": { name: "ã‚°ãƒ©ã‚¹ã‚¦ãƒ¼ãƒ«æ–­ç†±æ (50mm/32k)", data: [0.25, 0.65, 0.95, 0.98, 0.95, 0.90] }
    },
    products: {
        "STANDARD": {
            name: "1. ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« (EQ Series)",
            models: {
                "STD": { n: "EQ Standard", d: { "30": [0.20, 0.50, 0.95, 1.05, 1.05, 1.00], "60": [0.30, 0.80, 1.10, 1.10, 1.00, 1.00], "120": [0.50, 0.95, 1.10, 1.05, 1.00, 0.95] }, s: { "6x6": 0.36, "6x12": 0.72 } },
                "R": { n: "EQ R (Rococo)", d: { "30": [0.25, 0.55, 0.98, 1.08, 1.07, 1.02], "60": [0.35, 0.85, 1.12, 1.12, 1.02, 1.02], "120": [0.55, 0.98, 1.12, 1.08, 1.02, 0.98] }, s: { "6x6": 0.36, "6x12": 0.72 } },
                "B": { n: "EQ B (Baroque)", d: { "30": [0.22, 0.52, 0.96, 1.06, 1.06, 1.01], "60": [0.32, 0.82, 1.11, 1.11, 1.01, 1.01], "120": [0.52, 0.96, 1.11, 1.06, 1.01, 0.96] }, s: { "6x6": 0.36, "6x12": 0.72 } },
                "F": { n: "EQ Fabric", d: { "30": [0.18, 0.48, 0.93, 1.03, 1.03, 0.98], "60": [0.28, 0.78, 1.08, 1.08, 0.98, 0.98] }, s: { "6x6": 0.36, "6x12": 0.72 } }
            }
        },
        "OFFICE_FABRIC": {
            name: "2. ã‚ªãƒ•ã‚£ã‚¹ç”¨ãƒ•ã‚¡ãƒ–ãƒªãƒƒã‚¯ (Walleasear)",
            models: {
                "EQ30T": { n: "EQ 30T (å¤§é¢ç©æ–½å·¥)", d: { "30": [0.19, 0.49, 0.94, 1.04, 1.04, 0.99] }, s: { "12x6": 0.72, "24x6": 1.44 } },
                "EQ60T": { n: "EQ 60T (å¤§é¢ç©æ–½å·¥)", d: { "60": [0.29, 0.79, 1.09, 1.09, 0.99, 0.99] }, s: { "12x6": 0.72, "24x6": 1.44 } },
                "EQ100T": { n: "EQ 100T (å¤§é¢ç©æ–½å·¥)", d: { "100": [0.45, 0.92, 1.10, 1.07, 1.00, 0.96] }, s: { "12x6": 0.72, "24x6": 1.44 } }
            }
        },
        "ENGINEERING": {
            name: "3. ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°è£½å“",
            models: {
                "MT_BAFFLE": { n: "MT Baffle (å¤©äº•åŠä¸‹ã’)", d: { "40": [0.42, 0.78, 0.95, 0.98, 0.98, 0.96] }, s: { "6x4": 0.24, "12x4": 0.48 } },
                "CM": { n: "CM Series (ã‚¯ãƒ©ã‚¦ãƒ‰/å¤©äº•ç”¨)", d: { "30": [0.21, 0.53, 0.88, 0.96, 0.98, 0.94], "60": [0.38, 0.84, 1.05, 1.08, 1.02, 0.98] }, s: { "6x6": 0.36 } },
                "IMAGINE": { n: "Imagine Panel (æ„åŒ ãƒ‘ãƒãƒ«)", d: { "30": [0.17, 0.46, 0.91, 1.02, 1.03, 0.97] }, s: { "6x6": 0.36 } }
            }
        },
        "BROADBAND": {
            name: "4. ãƒ–ãƒ­ãƒ¼ãƒ‰ãƒãƒ³ãƒ‰å¸éŸ³æ",
            models: {
                "F300H": { n: "F300H (é«˜åŸŸç‰¹åŒ–)", d: { "30": [0.10, 0.35, 0.70, 0.95, 1.08, 1.05] }, s: { "3x3": 0.09 } },
                "F300M": { n: "F300M (ä¸­åŸŸç‰¹åŒ–)", d: { "30": [0.15, 0.55, 0.98, 1.05, 0.95, 0.85] }, s: { "3x3": 0.09 } },
                "F300W": { n: "F300W (ä½åŸŸç‰¹åŒ–)", d: { "30": [0.35, 0.75, 0.95, 0.90, 0.80, 0.70] }, s: { "3x3": 0.09 } }
            }
        },
        "BASSTRAP": {
            name: "5. ãƒ™ãƒ¼ã‚¹ãƒˆãƒ©ãƒƒãƒ— (ä½åŸŸåˆ¶å¾¡)",
            models: {
                "C300W": { n: "C300W (ã‚³ãƒ¼ãƒŠãƒ¼ç”¨)", d: { "300": [0.65, 0.95, 1.05, 1.00, 0.92, 0.85] }, s: { "3x3": 0.09 } },
                "CYLINDER350": { n: "Cylinder 350 (å††ç­’å‹)", d: { "350": [0.70, 0.98, 1.08, 1.02, 0.94, 0.88] }, s: { "custom": 0.12 } }
            }
        },
        "DIFFUSION": {
            name: "6. æ‹¡æ•£ãƒ‘ãƒãƒ« (éŸ¿ãã®èª¿æ•´)",
            models: {
                "CLOUD2C": { n: "Cloud 2C (å¹³é¢æ‹¡æ•£)", d: { "70": [0.05, 0.10, 0.15, 0.12, 0.10, 0.08] }, s: { "6x6": 0.36 }, diffusion: 0.7 },
                "CLOUD2D": { n: "Cloud 2D (å‡¹å‡¸æ‹¡æ•£)", d: { "70": [0.08, 0.15, 0.22, 0.18, 0.15, 0.12] }, s: { "6x6": 0.36 }, diffusion: 0.85 },
                "PEAK_SQ": { n: "Peak SQ (ã‚¹ã‚«ã‚¤ãƒ©ã‚¤ãƒ³)", d: { "80": [0.10, 0.18, 0.25, 0.20, 0.18, 0.15] }, s: { "6x6": 0.36 }, diffusion: 0.9 },
                "QRD_N29": { n: "QRD N29 (äºŒæ¬¡å…ƒæ‹¡æ•£)", d: { "100": [0.12, 0.20, 0.28, 0.25, 0.22, 0.18] }, s: { "6x6": 0.36 }, diffusion: 0.95 }
            }
        },
        "HYBRID": {
            name: "7. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ (å¸éŸ³+æ‹¡æ•£)",
            models: {
                "AQ1000S": { n: "AQ 1000S", d: { "50": [0.25, 0.60, 0.85, 0.88, 0.82, 0.75] }, s: { "6x6": 0.36 }, diffusion: 0.4 },
                "WAVE600": { n: "WAVE 600", d: { "60": [0.30, 0.68, 0.92, 0.95, 0.88, 0.80] }, s: { "6x6": 0.36 }, diffusion: 0.5 },
                "BREEZE": { n: "Breeze (æ„åŒ æ€§ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰)", d: { "40": [0.20, 0.55, 0.88, 0.92, 0.85, 0.78] }, s: { "6x6": 0.36 }, diffusion: 0.35 }
            }
        }
    }
};

const FREQS = [125, 250, 500, 1000, 2000, 4000];
let chart;
let selectedSpecs = [{}, {}, {}];
let lastData = {};
let currentMode = 'sim';
let measurementData = null;

function init() {
    const appSelect = document.getElementById('appTarget');
    SOUNDBOX_DB.apps.forEach((app, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = app.name;
        appSelect.appendChild(option);
    });

    const materialSelects = ['baseWall', 'baseCeiling', 'baseFloor', 'exMat'];
    materialSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        for (let key in SOUNDBOX_DB.materials) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = SOUNDBOX_DB.materials[key].name;
            select.appendChild(option);
        }
    });

    const sbInputsContainer = document.getElementById('sbInputs');
    sbInputsContainer.innerHTML = '';
    
    for (let i = 0; i < 3; i++) {
        const row = document.createElement('div');
        row.className = 'grid-row';
        row.innerHTML = `
            <div>
                <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                <select id="cat_${i}" onchange="onCategoryChange(${i})"></select>
            </div>
            <div class="custom-select-container">
                <div class="custom-select-trigger" id="trigger_${i}" onclick="togglePanel(${i})">
                    è£½å“ã‚¹ãƒšãƒƒã‚¯ã‚’é¸æŠ...
                </div>
                <div class="sub-panel" id="panel_${i}">
                    <div class="panel-cols">
                        <div id="col_model_${i}"></div>
                        <div id="col_thick_${i}"></div>
                        <div id="col_size_${i}"></div>
                    </div>
                </div>
            </div>
            <input type="number" id="qty_${i}" value="0" min="0" step="1" oninput="calculate()">
            <div id="unitArea_${i}" style="font-size:0.65rem; color:var(--dim); text-align:center;">-</div>
            <div id="totalArea_${i}" style="font-size:0.7rem; color:var(--primary); text-align:right; font-weight:bold;">-</div>
        `;
        sbInputsContainer.appendChild(row);

        const catSelect = document.getElementById(`cat_${i}`);
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'é¸æŠã—ã¦ãã ã•ã„...';
        catSelect.appendChild(defaultOption);
        
        for (let catKey in SOUNDBOX_DB.products) {
            const option = document.createElement('option');
            option.value = catKey;
            option.textContent = SOUNDBOX_DB.products[catKey].name;
            catSelect.appendChild(option);
        }
    }

    document.getElementById('appTarget').addEventListener('change', calculate);
    document.getElementById('w').addEventListener('input', calculate);
    document.getElementById('d').addEventListener('input', calculate);
    document.getElementById('h').addEventListener('input', calculate);
    document.getElementById('baseWall').addEventListener('change', calculate);
    document.getElementById('baseCeiling').addEventListener('change', calculate);
    document.getElementById('baseFloor').addEventListener('change', calculate);
    document.getElementById('exArea').addEventListener('input', calculate);
    document.getElementById('exMat').addEventListener('change', calculate);
    
    document.getElementById('showSpecial').addEventListener('change', function() {
        document.getElementById('specialPanel').style.display = this.checked ? 'block' : 'none';
        calculate();
    });

    calculate();
}

function setMode(mode) {
    currentMode = mode;
    
    const btnSim = document.getElementById('btnSim');
    const btnMeasure = document.getElementById('btnMeasure');
    
    if (mode === 'sim') {
        btnSim.classList.add('active');
        btnSim.classList.remove('measure');
        btnMeasure.classList.remove('active');
        btnMeasure.classList.remove('measure');
        document.getElementById('measurementPanel').style.display = 'none';
    } else {
        btnSim.classList.remove('active');
        btnMeasure.classList.add('active', 'measure');
        document.getElementById('measurementPanel').style.display = 'block';
        enumerateDevices();
    }
    
    const methodBadge = document.getElementById('methodBadge');
    methodBadge.textContent = mode === 'sim' ? 'SABINE' : 'EYRING';
    methodBadge.style.background = mode === 'sim' ? 'var(--accent)' : 'var(--warning)';
    
    calculate();
}

async function enumerateDevices() {
    const statusEl = document.getElementById('measureStatus');
    const micSelect = document.getElementById('micSelect');
    const spkSelect = document.getElementById('spkSelect');
    
    try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome/Edge/Firefoxã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        }
        
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            throw new Error('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã«ã‚ˆã‚Šã€HTTPSãƒšãƒ¼ã‚¸ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚');
        }
        
        statusEl.textContent = 'ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­...';
        statusEl.className = 'status-msg calibrating';
        
        let stream;
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                } 
            });
        } catch (permError) {
            if (permError.name === 'NotAllowedError') {
                throw new Error('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼æ¨ªã®ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
            } else if (permError.name === 'NotFoundError') {
                throw new Error('ãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒã‚¤ã‚¯ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else {
                throw new Error('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + permError.message);
            }
        }
        
        statusEl.textContent = 'ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ä¸­...';
        
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        
        const devices = await navigator.mediaDevices.enumerateDevices();
        
        micSelect.innerHTML = '<option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>';
        spkSelect.innerHTML = '<option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>';
        
        let micCount = 0;
        let spkCount = 0;
        
        devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            
            if (device.label) {
                option.textContent = device.label;
            } else {
                option.textContent = `${device.kind === 'audioinput' ? 'ãƒã‚¤ã‚¯' : 'ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼'} ${device.deviceId.substr(0, 8)}...`;
            }
            
            if (device.kind === 'audioinput') {
                micSelect.appendChild(option);
                micCount++;
            } else if (device.kind === 'audiooutput') {
                spkSelect.appendChild(option);
                spkCount++;
            }
        });
        
        if (micCount > 0) {
            statusEl.textContent = `âœ… ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºå®Œäº†: ãƒã‚¤ã‚¯ ${micCount}å°ã€ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ ${spkCount}å°`;
            statusEl.className = 'status-msg ready';
            
            if (micSelect.options.length > 1) {
                micSelect.selectedIndex = 1;
            }
            if (spkSelect.options.length > 1) {
                spkSelect.selectedIndex = 1;
            }
        } else {
            statusEl.textContent = 'âš ï¸ ãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒã‚¤ã‚¯ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            statusEl.className = 'status-msg error';
        }
        
    } catch (error) {
        let errorMsg = 'ãƒ‡ãƒã‚¤ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
        
        if (error.message) {
            errorMsg = error.message;
        }
        
        statusEl.textContent = 'âŒ ' + errorMsg;
        statusEl.className = 'status-msg error';
        
        micSelect.innerHTML = '<option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>';
        spkSelect.innerHTML = '<option value="">ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ...</option>';
    }
}

function onCategoryChange(index) {
    selectedSpecs[index] = {};
    document.getElementById(`trigger_${index}`).textContent = 'è£½å“ã‚¹ãƒšãƒƒã‚¯ã‚’é¸æŠ...';
    document.getElementById(`panel_${index}`).classList.remove('active');
    document.getElementById(`unitArea_${index}`).textContent = '-';
    document.getElementById(`totalArea_${index}`).textContent = '-';
    renderPanel(index);
    calculate();
}

function togglePanel(index) {
    const panel = document.getElementById(`panel_${index}`);
    const isActive = panel.classList.contains('active');
    
    document.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
    
    if (!isActive) {
        panel.classList.add('active');
        renderPanel(index);
    }
}

function renderPanel(index) {
    const categoryKey = document.getElementById(`cat_${index}`).value;
    
    if (!categoryKey) {
        document.getElementById(`col_model_${index}`).innerHTML = '<div class="col-title">MODEL</div>';
        document.getElementById(`col_thick_${index}`).innerHTML = '<div class="col-title">THICKNESS</div>';
        document.getElementById(`col_size_${index}`).innerHTML = '<div class="col-title">SIZE</div>';
        return;
    }
    
    const category = SOUNDBOX_DB.products[categoryKey];
    const spec = selectedSpecs[index];
    
    const modelCol = document.getElementById(`col_model_${index}`);
    modelCol.innerHTML = '<div class="col-title">MODEL</div>';
    
    for (let modelKey in category.models) {
        const modelDiv = document.createElement('div');
        modelDiv.className = 'col-item';
        if (spec.model === modelKey) modelDiv.classList.add('selected');
        modelDiv.textContent = category.models[modelKey].n;
        modelDiv.onclick = () => selectModel(index, categoryKey, modelKey);
        modelCol.appendChild(modelDiv);
    }
    
    const thickCol = document.getElementById(`col_thick_${index}`);
    thickCol.innerHTML = '<div class="col-title">THICKNESS</div>';
    
    if (spec.model) {
        const model = category.models[spec.model];
        for (let thickKey in model.d) {
            const thickDiv = document.createElement('div');
            thickDiv.className = 'col-item';
            if (spec.thick === thickKey) thickDiv.classList.add('selected');
            thickDiv.textContent = thickKey + 'mm';
            thickDiv.onclick = () => selectThickness(index, categoryKey, spec.model, thickKey);
            thickCol.appendChild(thickDiv);
        }
    }
    
    const sizeCol = document.getElementById(`col_size_${index}`);
    sizeCol.innerHTML = '<div class="col-title">SIZE</div>';
    
    if (spec.model && spec.thick) {
        const model = category.models[spec.model];
        for (let sizeKey in model.s) {
            const sizeDiv = document.createElement('div');
            sizeDiv.className = 'col-item';
            if (spec.size === sizeKey) sizeDiv.classList.add('selected');
            sizeDiv.textContent = sizeKey;
            sizeDiv.onclick = () => selectSize(index, categoryKey, spec.model, spec.thick, sizeKey);
            sizeCol.appendChild(sizeDiv);
        }
    }
}

function selectModel(index, categoryKey, modelKey) {
    selectedSpecs[index] = { category: categoryKey, model: modelKey };
    renderPanel(index);
}

function selectThickness(index, categoryKey, modelKey, thickKey) {
    selectedSpecs[index].thick = thickKey;
    renderPanel(index);
}

function selectSize(index, categoryKey, modelKey, thickKey, sizeKey) {
    selectedSpecs[index].size = sizeKey;
    
    const model = SOUNDBOX_DB.products[categoryKey].models[modelKey];
    document.getElementById(`trigger_${index}`).textContent = 
        `${model.n} / ${thickKey}mm / ${sizeKey}`;
    
    const unitArea = model.s[sizeKey];
    document.getElementById(`unitArea_${index}`).textContent = unitArea.toFixed(2) + 'ã¡';
    
    document.getElementById(`panel_${index}`).classList.remove('active');
    
    calculate();
}

function prepareForPrint() {
    window.print();
}

function calculate() {
    const w = parseFloat(document.getElementById('w').value) || 0.1;
    const d = parseFloat(document.getElementById('d').value) || 0.1;
    const h = parseFloat(document.getElementById('h').value) || 0.1;
    
    const V = w * d * h;
    const S_total = 2 * (w * d + d * h + h * w);
    const S_wall = 2 * (d * h + h * w);
    const S_ceiling = w * d;
    const S_floor = w * d;
    
    if (V <= 0 || S_total <= 0) {
        return;
    }
    
    const L_mean = (4 * V) / S_total;
    const diffusionIndicator = (L_mean * 0.12).toFixed(2);
    
    const appIndex = parseInt(document.getElementById('appTarget').value) || 0;
    const targetObj = SOUNDBOX_DB.apps[appIndex];
    const targetRT = targetObj.t;
    
    const wallMat = SOUNDBOX_DB.materials[document.getElementById('baseWall').value];
    const ceilingMat = SOUNDBOX_DB.materials[document.getElementById('baseCeiling').value];
    const floorMat = SOUNDBOX_DB.materials[document.getElementById('baseFloor').value];
    
    let exArea = 0;
    let exMat = null;
    if (document.getElementById('showSpecial').checked) {
        exArea = parseFloat(document.getElementById('exArea').value) || 0;
        const exMatKey = document.getElementById('exMat').value;
        exMat = SOUNDBOX_DB.materials[exMatKey];
    }
    
    const actualWallArea = Math.max(0, S_wall - exArea);
    
    const rt_before = [];
    const rt_after = [];
    
    const m_coeffs = [0, 0, 0, 0, 0.002, 0.007];
    
    for (let i = 0; i < 6; i++) {
        const freq = FREQS[i];
        
        let A_base = 0;
        A_base += actualWallArea * wallMat.data[i];
        A_base += S_ceiling * ceilingMat.data[i];
        A_base += S_floor * floorMat.data[i];
        if (exArea > 0 && exMat) {
            A_base += exArea * exMat.data[i];
        }
        
        const airAbsorption = 4 * m_coeffs[i] * V;
        
        let rt_b;
        
        if (currentMode === 'measure' && measurementData && measurementData[i]) {
            rt_b = measurementData[i];
        } else {
            rt_b = (0.161 * V) / (A_base + airAbsorption);
        }
        
        rt_before.push(rt_b);
        
        let A_panels = 0;
        
        for (let panelIdx = 0; panelIdx < 3; panelIdx++) {
            const spec = selectedSpecs[panelIdx];
            const qty = parseInt(document.getElementById(`qty_${panelIdx}`).value) || 0;
            
            if (spec.category && spec.model && spec.thick && spec.size && qty > 0) {
                const product = SOUNDBOX_DB.products[spec.category].models[spec.model];
                const alpha = product.d[spec.thick][i];
                const unitArea = product.s[spec.size];
                
                A_panels += unitArea * qty * (alpha - wallMat.data[i]);
            }
        }
        
        const A_total = A_base + A_panels + airAbsorption;
        
        const avgAlpha = Math.min(A_total / S_total, 0.999);
        
        let rt_a;
        
        if (currentMode === 'measure') {
            rt_a = (0.161 * V) / (-S_total * Math.log(1 - avgAlpha) + airAbsorption);
        } else {
            rt_a = (0.161 * V) / A_total;
        }
        
        rt_after.push(rt_a);
    }
    
    const avgRT_before = (rt_before[2] + rt_before[3]) / 2;
    const avgRT_after = (rt_after[2] + rt_after[3]) / 2;
    
    let totalPanelM2 = 0;
    
    for (let panelIdx = 0; panelIdx < 3; panelIdx++) {
        const spec = selectedSpecs[panelIdx];
        const qty = parseInt(document.getElementById(`qty_${panelIdx}`).value) || 0;
        
        if (spec.category && spec.model && spec.size && qty > 0) {
            const product = SOUNDBOX_DB.products[spec.category].models[spec.model];
            const unitArea = product.s[spec.size];
            totalPanelM2 += unitArea * qty;
            
            document.getElementById(`totalArea_${panelIdx}`).textContent = 
                (unitArea * qty).toFixed(2) + 'ã¡';
        } else {
            document.getElementById(`totalArea_${panelIdx}`).textContent = '-';
        }
    }
    
    const usableSurface = S_wall * 0.8;
    
    const achievementRate = (targetRT / avgRT_after) * 100;
    
    updateUI(rt_before, rt_after, avgRT_before, avgRT_after, targetRT, targetObj, 
             achievementRate, totalPanelM2, usableSurface, V, diffusionIndicator);
}

function updateUI(rt_before, rt_after, avgBefore, avgAfter, targetRT, targetObj, 
                  achievementRate, totalPanelM2, usableSurface, V, diffusionIndicator) {
    
    document.getElementById('postRT_Avg').textContent = avgAfter.toFixed(2) + 's';
    document.getElementById('targetLabel').textContent = `ç›®æ¨™: ${targetRT}s`;
    
    document.getElementById('achievementRate').textContent = achievementRate.toFixed(0) + '%';
    
    document.getElementById('totalPanelArea').textContent = 
        `${totalPanelM2.toFixed(1)} / ${usableSurface.toFixed(1)}ã¡`;
    
    document.getElementById('diffusionBalance').textContent = 
        `æ‹¡æ•£å¯„ä¸åº¦: ${diffusionIndicator}`;
    
    const cardHealth = document.getElementById('cardHealth');
    const healthStatus = document.getElementById('healthStatus');
    const adviceHeader = document.getElementById('adviceHeader');
    const detailedNote = document.getElementById('detailedNote');
    
    let status, statusColor, adviceTagColor, adviceText;
    
    if (totalPanelM2 > usableSurface) {
        status = 'è¨­ç½®é™ç•Œè¶…é';
        statusColor = 'var(--danger)';
        adviceTagColor = '#ff7b72';
        adviceHeader.textContent = 'FAIL';
        adviceHeader.style.background = adviceTagColor;
        adviceText = 'å£é¢ã®æœ‰åŠ¹é¢ç©ï¼ˆ80%ï¼‰ã‚’è¶…ãˆã‚‹ãƒ‘ãƒãƒ«ãŒé…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‘ãƒãƒ«æšæ•°ã‚’æ¸›ã‚‰ã™ã‹ã€ã‚ˆã‚Šåšå‹ã®ãƒ‘ãƒãƒ«ã¸ã®å¤‰æ›´ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚';
    }
    else if (achievementRate >= 120) {
        status = 'éŸ¿ããŒå°‘ãªã„';
        statusColor = 'var(--caution)';
        adviceTagColor = '#f0883e';
        adviceHeader.textContent = 'OVER';
        adviceHeader.style.background = adviceTagColor;
        adviceText = 'ç©ºé–“ãŒãƒ‡ãƒƒãƒ‰éãã‚‹å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚æ‹¡æ•£ãƒ‘ãƒãƒ«ã‚’æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚';
    }
    else if (achievementRate >= 100) {
        status = 'ç†æƒ³çš„';
        statusColor = 'var(--success)';
        adviceTagColor = '#39d353';
        adviceHeader.textContent = 'IDEAL';
        adviceHeader.style.background = adviceTagColor;
        adviceText = 'ç†æƒ³çš„ãªæ•°å€¤ã§ã™ã€‚ç›®æ¨™ã®æ®‹éŸ¿æ™‚é–“ã‚’é”æˆã—ã¦ã„ã¾ã™ã€‚';
    }
    else if (achievementRate >= 80) {
        status = 'å®Ÿç”¨ãƒ¬ãƒ™ãƒ«';
        statusColor = 'var(--accent)';
        adviceTagColor = '#388bfd';
        adviceHeader.textContent = 'GOOD';
        adviceHeader.style.background = adviceTagColor;
        adviceText = 'å®Ÿç”¨ä¸Šååˆ†ãªå°å…¥åŠ¹æœã§ã™ã€‚ä½åŸŸã®åˆ¶å¾¡ã«ã¯åšå‹ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚';
    }
    else {
        status = 'å¸éŸ³ä¸è¶³';
        statusColor = 'var(--danger)';
        adviceTagColor = '#ff7b72';
        adviceHeader.textContent = 'UNDER';
        adviceHeader.style.background = adviceTagColor;
        adviceText = 'ç›®æ¨™æ®‹éŸ¿æ™‚é–“ã«é”ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ‘ãƒãƒ«å¢—è¨­ã‚’æ¨å¥¨ã—ã¾ã™ã€‚';
    }
    
    healthStatus.textContent = status;
    healthStatus.style.color = statusColor;
    cardHealth.style.borderColor = statusColor;
    
    if (V < 30) {
        adviceText += '<br><br><strong style="color:#ffb86c;">âš ï¸ Small Room Analysis</strong><br>';
        adviceText += 'æœ¬ç©ºé–“ã¯å®¹ç©ãŒå°ã•ã„ãŸã‚ã€è¨ˆç®—ä¸Šã®æ•°å€¤ã‚ˆã‚Šã‚‚ã€å¹³è¡Œé¢ã§ç™ºç”Ÿã™ã‚‹å®šåœ¨æ³¢ï¼ˆãƒ–ãƒ¼ãƒŸãƒ³ã‚°ï¼‰ã®æŠ‘åˆ¶ãŒé‡è¦ã§ã™ã€‚å£é¢ã®ä¸­å¤®ã ã‘ã§ãªãã€å…¥éš…ï¼ˆã‚³ãƒ¼ãƒŠãƒ¼ï¼‰ã¸ã®å¸éŸ³æé…ç½®ã‚’å„ªå…ˆã™ã‚‹ã“ã¨ã§ã€ä½åŸŸã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’åŠ¹ç‡çš„ã«å‡¦ç†ã§ãã¾ã™ã€‚';
    }
    
    if (rt_after[0] > avgAfter * 1.5) {
        adviceText += '<br><br><strong style="color:#ffb86c;">âš ï¸ 125Hz ä½åŸŸæ®‹éŸ¿è­¦å‘Š</strong><br>';
        adviceText += '125Hzã®æ®‹éŸ¿æ™‚é–“ãŒçªå‡ºã—ã¦ã„ã¾ã™ã€‚ä½åŸŸã®åˆ¶å¾¡ã«ã¯120mmåšã®ãƒ‘ãƒãƒ«ã€ã¾ãŸã¯ã‚³ãƒ¼ãƒŠãƒ¼é…ç½®ã®ãƒ™ãƒ¼ã‚¹ãƒˆãƒ©ãƒƒãƒ—ã‚’æ¨å¥¨ã—ã¾ã™ã€‚';
    }
    
    detailedNote.innerHTML = adviceText;
    
    updateChart(rt_before, rt_after, targetRT);
    
    lastData = {
        rt_after: avgAfter,
        rt_before: avgBefore,
        targetRT: targetRT,
        achievementRate: achievementRate,
        totalPanelM2: totalPanelM2,
        V: V,
        status: status
    };
}

window.addEventListener('DOMContentLoaded', init);
</script>

<script>
const workerCode = `
// ========================================
// ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°é–¢æ•°
// ========================================
function log(message, data) {
    console.log('[Worker] ' + message, data || '');
    self.postMessage({
        type: 'debug',
        message: message,
        data: data
    });
}

// ========================================
// å“è³ªãƒã‚§ãƒƒã‚¯é–¢æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
// ========================================
function assessRecordingQuality(recordedData, sampleRate, noiseFloor) {
    log('=== éŒ²éŸ³å“è³ªè©•ä¾¡é–‹å§‹ ===');
    
    const quality = {
        passed: false,
        level: 'poor',
        snr: 0,
        dynamicRange: 0,
        peakValue: 0,
        clippingRatio: 0,
        expectedMethod: 'failed',
        issues: [],
        details: {}
    };
    
    // 1. ãƒ”ãƒ¼ã‚¯æ¤œå‡ºã¨ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
    let maxValue = 0;
    let minValue = 0;
    let clippingCount = 0;
    const CLIPPING_THRESHOLD = 0.99;
    
    for (let i = 0; i < recordedData.length; i++) {
        const value = recordedData[i];
        maxValue = Math.max(maxValue, Math.abs(value));
        minValue = Math.min(minValue, value);
        
        if (Math.abs(value) > CLIPPING_THRESHOLD) {
            clippingCount++;
        }
    }
    
    quality.peakValue = maxValue;
    quality.clippingRatio = (clippingCount / recordedData.length) * 100;
    
    log('ãƒ”ãƒ¼ã‚¯æ¤œå‡ºå®Œäº†', {
        peak: maxValue.toFixed(4),
        clipping: quality.clippingRatio.toFixed(2) + '%'
    });
    
    // 2. S/Næ¯”è¨ˆç®—
    let signalPower = 0;
    const signalStart = Math.floor(recordedData.length * 0.1); // æœ€åˆã®10%ã‚’ã‚¹ã‚­ãƒƒãƒ—
    const signalEnd = Math.floor(recordedData.length * 0.6);   // 60%åœ°ç‚¹ã¾ã§
    const signalLength = signalEnd - signalStart;
    
    for (let i = signalStart; i < signalEnd; i++) {
        signalPower += recordedData[i] * recordedData[i];
    }
    signalPower /= signalLength;
    
    const noisePower = noiseFloor * noiseFloor;
    quality.snr = 10 * Math.log10(signalPower / noisePower);
    
    log('S/Næ¯”è¨ˆç®—å®Œäº†', { snr: quality.snr.toFixed(1) + 'dB' });
    
    // 3. ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ¬ãƒ³ã‚¸æ¨å®šï¼ˆæ¸›è¡°ã®è¦³æ¸¬ï¼‰
    // å¾ŒåŠã®ãƒã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ã‚’æ¨å®š
    const tailStart = Math.floor(recordedData.length * 0.8);
    let tailPower = 0;
    
    for (let i = tailStart; i < recordedData.length; i++) {
        tailPower += recordedData[i] * recordedData[i];
    }
    tailPower /= (recordedData.length - tailStart);
    
    const tailLevel = Math.sqrt(tailPower);
    quality.dynamicRange = 20 * Math.log10(maxValue / Math.max(tailLevel, 1e-10));
    
    log('ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ¬ãƒ³ã‚¸è¨ˆç®—å®Œäº†', { 
        range: quality.dynamicRange.toFixed(1) + 'dB' 
    });
    
    // 4. ãƒ‡ãƒ¼ã‚¿ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
    if (maxValue < 0.001) {
        quality.issues.push('ä¿¡å·ãƒ¬ãƒ™ãƒ«ãŒæ¥µç«¯ã«ä½ã„ï¼ˆã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼éŸ³é‡ã‚’ä¸Šã’ã¦ãã ã•ã„ï¼‰');
    }
    
    if (quality.clippingRatio > 1.0) {
        quality.issues.push('ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°ç™ºç”Ÿï¼ˆã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼éŸ³é‡ã‚’ä¸‹ã’ã¦ãã ã•ã„ï¼‰');
    }
    
    if (maxValue < 0.01 && quality.clippingRatio === 0) {
        quality.issues.push('ä¿¡å·ãƒ¬ãƒ™ãƒ«ä¸è¶³ï¼ˆãƒã‚¤ã‚¯ã¨ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã®è·é›¢ã‚’è¿‘ã¥ã‘ã¦ãã ã•ã„ï¼‰');
    }
    
    // 5. å“è³ªãƒ¬ãƒ™ãƒ«ã®åˆ¤å®šï¼ˆISO 3382-2 æº–æ‹ ï¼‰
    quality.details = {
        snr: quality.snr,
        dynamicRange: quality.dynamicRange,
        peakValue: maxValue,
        clipping: quality.clippingRatio
    };
    
    // T60æ¸¬å®šå¯èƒ½ãƒ¬ãƒ™ãƒ«ï¼ˆç†æƒ³ï¼‰
    if (quality.snr >= 45 && quality.dynamicRange >= 60 && quality.clippingRatio < 0.1) {
        quality.level = 'excellent';
        quality.expectedMethod = 'T60';
        quality.passed = true;
    }
    // T30æ¸¬å®šå¯èƒ½ãƒ¬ãƒ™ãƒ«ï¼ˆæ¨å¥¨ï¼‰
    else if (quality.snr >= 30 && quality.dynamicRange >= 35 && quality.clippingRatio < 0.5) {
        quality.level = 'good';
        quality.expectedMethod = 'T30';
        quality.passed = true;
    }
    // T20æ¸¬å®šå¯èƒ½ãƒ¬ãƒ™ãƒ«ï¼ˆæœ€ä½åŸºæº–ï¼‰
    else if (quality.snr >= 20 && quality.dynamicRange >= 25 && quality.clippingRatio < 1.0) {
        quality.level = 'acceptable';
        quality.expectedMethod = 'T20';
        quality.passed = true;
    }
    // åŸºæº–æœªæº€ï¼ˆå†æ¸¬å®šãŒå¿…è¦ï¼‰
    else {
        quality.level = 'poor';
        quality.expectedMethod = 'failed';
        quality.passed = false;
        
        // å…·ä½“çš„ãªæ”¹å–„ææ¡ˆ
        if (quality.snr < 20) {
            quality.issues.push(\`S/Næ¯”ä¸è¶³: \${quality.snr.toFixed(1)}dBï¼ˆæ¨å¥¨: 20dBä»¥ä¸Šï¼‰ç’°å¢ƒãƒã‚¤ã‚ºã‚’æ¸›ã‚‰ã™ã‹ã€ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼éŸ³é‡ã‚’ä¸Šã’ã¦ãã ã•ã„\`);
        }
        
        if (quality.dynamicRange < 25) {
            quality.issues.push(\`ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ¬ãƒ³ã‚¸ä¸è¶³: \${quality.dynamicRange.toFixed(1)}dBï¼ˆæ¨å¥¨: 25dBä»¥ä¸Šï¼‰ãƒã‚¤ã‚¯ã¨ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã®è·é›¢ã‚’èª¿æ•´ã—ã¦ãã ã•ã„\`);
        }
        
        if (quality.clippingRatio > 1.0) {
            quality.issues.push(\`ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°ç‡: \${quality.clippingRatio.toFixed(2)}%ï¼ˆè¨±å®¹: 1%æœªæº€ï¼‰ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼éŸ³é‡ã‚’ä¸‹ã’ã¦ãã ã•ã„\`);
        }
    }
    
    log('=== å“è³ªè©•ä¾¡å®Œäº† ===', {
        level: quality.level,
        expectedMethod: quality.expectedMethod,
        passed: quality.passed ? 'âœ… åˆæ ¼' : 'âŒ ä¸åˆæ ¼'
    });
    
    return quality;
}

// ========================================
// FFTå®Ÿè£…
// ========================================
function fft(real, imag) {
    const n = real.length;
    if (n <= 1) return;
    
    let j = 0;
    for (let i = 0; i < n - 1; i++) {
        if (i < j) {
            [real[i], real[j]] = [real[j], real[i]];
            [imag[i], imag[j]] = [imag[j], imag[i]];
        }
        let k = n >> 1;
        while (k <= j) {
            j -= k;
            k >>= 1;
        }
        j += k;
    }
    
    for (let len = 2; len <= n; len <<= 1) {
        const angle = -2 * Math.PI / len;
        const wlen_r = Math.cos(angle);
        const wlen_i = Math.sin(angle);
        
        for (let i = 0; i < n; i += len) {
            let w_r = 1;
            let w_i = 0;
            
            for (let j = 0; j < len / 2; j++) {
                const u_r = real[i + j];
                const u_i = imag[i + j];
                const v_r = real[i + j + len / 2] * w_r - imag[i + j + len / 2] * w_i;
                const v_i = real[i + j + len / 2] * w_i + imag[i + j + len / 2] * w_r;
                
                real[i + j] = u_r + v_r;
                imag[i + j] = u_i + v_i;
                real[i + j + len / 2] = u_r - v_r;
                imag[i + j + len / 2] = u_i - v_i;
                
                const temp_r = w_r * wlen_r - w_i * wlen_i;
                w_i = w_r * wlen_i + w_i * wlen_r;
                w_r = temp_r;
            }
        }
    }
}

// ========================================
// ãƒãƒ³ãƒ‰ãƒ‘ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
// ========================================
function applyBandpassFilter(data, sampleRate, centerFreq, bandwidth) {
    log('ãƒãƒ³ãƒ‰ãƒ‘ã‚¹ãƒ•ã‚£ãƒ«ã‚¿é–‹å§‹', { freq: centerFreq, dataLength: data.length });
    
    const lowFreq = centerFreq / Math.sqrt(2);
    const highFreq = centerFreq * Math.sqrt(2);
    
    const originalLength = data.length;
    const powerOf2 = Math.pow(2, Math.ceil(Math.log2(originalLength)));
    
    log('ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºèª¿æ•´', { 
        original: originalLength, 
        paddedTo: powerOf2,
        ratio: (powerOf2 / originalLength).toFixed(2)
    });
    
    const n = powerOf2;
    
    const real = new Float32Array(n);
    const imag = new Float32Array(n);
    
    for (let i = 0; i < originalLength; i++) {
        real[i] = data[i];
    }
    
    log('é †æ–¹å‘FFTé–‹å§‹');
    fft(real, imag);
    
    log('å‘¨æ³¢æ•°é ˜åŸŸãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ä¸­');
    for (let i = 0; i < n; i++) {
        const freq = i * sampleRate / n;
        if (freq < lowFreq || freq > highFreq) {
            real[i] = 0;
            imag[i] = 0;
        }
    }
    
    log('é€†æ–¹å‘FFTé–‹å§‹');
    for (let i = 0; i < n; i++) {
        imag[i] = -imag[i];
    }
    fft(real, imag);
    for (let i = 0; i < n; i++) {
        real[i] /= n;
        imag[i] = -imag[i] / n;
    }
    
    log('ãƒãƒ³ãƒ‰ãƒ‘ã‚¹ãƒ•ã‚£ãƒ«ã‚¿å®Œäº†');
    
    const result = new Float32Array(originalLength);
    for (let i = 0; i < originalLength; i++) {
        result[i] = real[i];
    }
    
    return result;
}

// ========================================
// ã‚·ãƒ¥ãƒ¬ãƒ¼ãƒ€ãƒ¼ç©åˆ†
// ========================================
function schroederIntegration(impulseResponse) {
    const n = impulseResponse.length;
    const edc = new Float32Array(n);
    
    let sum = 0;
    for (let i = n - 1; i >= 0; i--) {
        sum += impulseResponse[i] * impulseResponse[i];
        edc[i] = sum;
    }
    
    const maxEnergy = edc[0];
    if (maxEnergy > 0) {
        for (let i = 0; i < n; i++) {
            edc[i] /= maxEnergy;
        }
    }
    
    return edc;
}

// ========================================
// RTæ¸¬å®šè©¦è¡Œ
// ========================================
function tryMeasureRT(edcDB, sampleRate, startDB, endDB) {
    const n = edcDB.length;
    
    let tStart = -1;
    for (let i = 0; i < n; i++) {
        if (edcDB[i] <= startDB) {
            tStart = i;
            break;
        }
    }
    
    if (tStart < 0) {
        return { success: false, time: null };
    }
    
    let tEnd = -1;
    for (let i = tStart; i < n; i++) {
        if (edcDB[i] <= endDB) {
            tEnd = i;
            break;
        }
    }
    
    if (tEnd < 0 || tEnd <= tStart) {
        return { success: false, time: null };
    }
    
    const decayTime = (tEnd - tStart) / sampleRate;
    
    if (decayTime < 0.01 || decayTime > 10.0) {
        return { success: false, time: null };
    }
    
    return { success: true, time: decayTime };
}

// ========================================
// RTè¨ˆç®—ï¼ˆT60/T30/T20ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
// ========================================
function calculateRT(edc, sampleRate) {
    const n = edc.length;
    
    const edcDB = new Float32Array(n);
    for (let i = 0; i < n; i++) {
        edcDB[i] = 10 * Math.log10(Math.max(edc[i], 1e-10));
    }
    
    const t60Result = tryMeasureRT(edcDB, sampleRate, -5, -65);
    if (t60Result.success) {
        return {
            value: t60Result.time,
            method: 'T60',
            quality: 'excellent',
            description: 'RT60ç›´æ¥æ¸¬å®šï¼ˆ60dBãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ¬ãƒ³ã‚¸ï¼‰'
        };
    }
    
    const t30Result = tryMeasureRT(edcDB, sampleRate, -5, -35);
    if (t30Result.success) {
        return {
            value: t30Result.time * 2.0,
            method: 'T30',
            quality: 'good',
            description: 'T30æ¸¬å®šï¼ˆ30dBãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ¬ãƒ³ã‚¸ã€èª¤å·®Â±2-5%ï¼‰'
        };
    }
    
    const t20Result = tryMeasureRT(edcDB, sampleRate, -5, -25);
    if (t20Result.success) {
        return {
            value: t20Result.time * 3.0,
            method: 'T20',
            quality: 'acceptable',
            description: 'T20æ¸¬å®šï¼ˆ20dBãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ¬ãƒ³ã‚¸ã€èª¤å·®Â±5-10%ï¼‰'
        };
    }
    
    return {
        value: null,
        method: 'failed',
        quality: 'poor',
        description: 'æ¸¬å®šå¤±æ•—ï¼ˆãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ¬ãƒ³ã‚¸ä¸è¶³ï¼‰'
    };
}

// ========================================
// SNRè¨ˆç®—
// ========================================
function calculateSNR(signal, noiseFloor) {
    let signalPower = 0;
    for (let i = 0; i < signal.length; i++) {
        signalPower += signal[i] * signal[i];
    }
    signalPower /= signal.length;
    
    const snr = 10 * Math.log10(signalPower / (noiseFloor * noiseFloor));
    return snr;
}

// ========================================
// ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©
// ========================================
self.onmessage = function(e) {
    log('=== Workeré–‹å§‹ ===');
    
    const { type, data } = e.data;
    
    if (type === 'analyze') {
        log('è§£æã‚¿ã‚¤ãƒ—ç¢ºèª: analyze');
        const { recordedData, sampleRate, noiseFloor } = data;
        
        log('å—ä¿¡ãƒ‡ãƒ¼ã‚¿ç¢ºèª', {
            dataLength: recordedData.length,
            sampleRate: sampleRate,
            noiseFloor: noiseFloor,
            duration: (recordedData.length / sampleRate).toFixed(2) + 'ç§’'
        });
        
        try {
            // ========================================
            // Phase 1: å“è³ªè©•ä¾¡ï¼ˆæ–°è¦è¿½åŠ ï¼‰
            // ========================================
            const qualityCheck = assessRecordingQuality(recordedData, sampleRate, noiseFloor);
            
            if (!qualityCheck.passed) {
                log('âŒ å“è³ªãƒã‚§ãƒƒã‚¯ä¸åˆæ ¼ - å†æ¸¬å®šãŒå¿…è¦');
                
                // æ—¢å­˜ã®å†æ¸¬å®šãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’èµ·å‹•
                self.postMessage({
                    type: 'result',
                    rt60: [null, null, null, null, null, null],
                    snr: [0, 0, 0, 0, 0, 0, 0, 0],
                    quality: 'poor',
                    qualityReason: 'éŒ²éŸ³å“è³ªãŒä¸ååˆ†ã§ã™:\\n' + qualityCheck.issues.join('\\n'),
                    methods: ['failed', 'failed', 'failed', 'failed', 'failed', 'failed'],
                    primaryMethod: 'failed',
                    methodCounts: { T60: 0, T30: 0, T20: 0, failed: 6 }
                });
                
                log('=== Workerå®Œäº†ï¼ˆå†æ¸¬å®šæ¨å¥¨ï¼‰ ===');
                return;
            }
            
            log('âœ… å“è³ªãƒã‚§ãƒƒã‚¯åˆæ ¼', {
                level: qualityCheck.level,
                expectedMethod: qualityCheck.expectedMethod,
                snr: qualityCheck.snr.toFixed(1) + 'dB',
                dynamicRange: qualityCheck.dynamicRange.toFixed(1) + 'dB'
            });
            
            // ========================================
            // Phase 2: å‘¨æ³¢æ•°å¸¯åŸŸåˆ¥è§£æï¼ˆæ—¢å­˜å‡¦ç†ï¼‰
            // ========================================
            log('è§£æå‡¦ç†é–‹å§‹');
            const startTime = Date.now();
            
            const freqBands = [125, 250, 500, 1000, 2000, 4000];
            const rt60Results = [];
            const snrResults = [];
            const methodsUsed = [];
            const qualityLevels = [];
            
            log('å‘¨æ³¢æ•°å¸¯åŸŸå‡¦ç†é–‹å§‹', { bands: freqBands.length });
            
            for (let i = 0; i < freqBands.length; i++) {
                log(\`===== å¸¯åŸŸ \${i+1}/6 å‡¦ç†é–‹å§‹ =====\`, { freq: freqBands[i] + 'Hz' });
                
                const centerFreq = freqBands[i];
                
                const filtered = applyBandpassFilter(recordedData, sampleRate, centerFreq, centerFreq);
                
                const edc = schroederIntegration(filtered);
                
                const rtResult = calculateRT(edc, sampleRate);
                log(\`RTè¨ˆç®—å®Œäº† \${i+1}/6\`, { 
                    method: rtResult.method, 
                    value: rtResult.value,
                    quality: rtResult.quality
                });
                
                const snr = calculateSNR(filtered, noiseFloor);
                log(\`SNRè¨ˆç®—å®Œäº† \${i+1}/6\`, { snr: snr.toFixed(1) + 'dB' });
                
                rt60Results.push(rtResult.value);
                snrResults.push(snr);
                methodsUsed.push(rtResult.method);
                qualityLevels.push(rtResult.quality);
                
                log(\`===== å¸¯åŸŸ \${i+1}/6 å‡¦ç†å®Œäº† =====\`);
            }
            
            log('å…¨å¸¯åŸŸå‡¦ç†å®Œäº†');
            log('å“è³ªè©•ä¾¡é–‹å§‹');
            
            let overallQuality = 'good';
            let qualityReason = '';
            
            const minSNR = Math.min(...snrResults.filter(s => !isNaN(s)));
            log('æœ€å°SNR', { value: minSNR.toFixed(1) + 'dB' });
            
            if (minSNR < 15) {
                overallQuality = 'poor';
                qualityReason = \`S/Næ¯”ä¸è¶³ï¼ˆ\${minSNR.toFixed(1)}dB < 15dBï¼‰ã€‚ç’°å¢ƒãƒã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚é™ã‹ãªç’°å¢ƒã§å†æ¸¬å®šã—ã¦ãã ã•ã„ã€‚\`;
            }
            
            const successCount = rt60Results.filter(rt => rt !== null).length;
            log('æ¸¬å®šæˆåŠŸæ•°', { count: successCount + '/6' });
            
            if (successCount < 4) {
                overallQuality = 'poor';
                qualityReason = \`æ¸¬å®šæˆåŠŸç‡ãŒä½ã™ãã¾ã™ï¼ˆ\${successCount}/6å¸¯åŸŸï¼‰ã€‚ã‚¹ã‚¤ãƒ¼ãƒ—éŸ³é‡ã‚’ä¸Šã’ã‚‹ã‹ã€ã‚ˆã‚Šé™ã‹ãªç’°å¢ƒã§å†æ¸¬å®šã—ã¦ãã ã•ã„ã€‚\`;
            }
            
            const validRT60 = rt60Results.filter(rt => rt !== null && rt >= 0.05 && rt <= 5.0);
            if (validRT60.length < successCount) {
                overallQuality = 'poor';
                qualityReason = 'RT60å€¤ãŒç‰©ç†çš„ã«å¦¥å½“ãªç¯„å›²å¤–ã§ã™ã€‚æ¸¬å®šç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            }
            
            const methodCounts = {
                T60: methodsUsed.filter(m => m === 'T60').length,
                T30: methodsUsed.filter(m => m === 'T30').length,
                T20: methodsUsed.filter(m => m === 'T20').length,
                failed: methodsUsed.filter(m => m === 'failed').length
            };
            
            log('æ¸¬å®šæ‰‹æ³•åˆ†å¸ƒ', methodCounts);
            
            let primaryMethod = 'T30';
            if (methodCounts.T60 >= 4) primaryMethod = 'T60';
            else if (methodCounts.T20 >= 4) primaryMethod = 'T20';
            
            log('å“è³ªè©•ä¾¡å®Œäº†', { quality: overallQuality, primaryMethod: primaryMethod });
            log('çµæœé€ä¿¡ä¸­...');
            
            self.postMessage({
                type: 'result',
                rt60: rt60Results,
                snr: snrResults,
                quality: overallQuality,
                qualityReason: qualityReason,
                methods: methodsUsed,
                primaryMethod: primaryMethod,
                methodCounts: methodCounts
            });
            
            const processingTime = (Date.now() - startTime) / 1000;
            log('=== Workerå®Œäº† ===', { processingTime: processingTime.toFixed(2) + 'ç§’' });
            
        } catch (error) {
            log('âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', { 
                message: error.message,
                stack: error.stack
            });
            
            self.postMessage({
                type: 'error',
                message: 'è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message
            });
        }
    }
};
`;

// ========================================
// SNRè¨ˆç®—
// ========================================
function calculateSNR(signal, noiseFloor) {
    let signalPower = 0;
    for (let i = 0; i < signal.length; i++) {
        signalPower += signal[i] * signal[i];
    }
    signalPower /= signal.length;
    
    const snr = 10 * Math.log10(signalPower / (noiseFloor * noiseFloor));
    return snr;
}

// ========================================
// ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©
// ========================================
self.onmessage = function(e) {
    log('=== Workeré–‹å§‹ ===');
    
    const { type, data } = e.data;
    
    if (type === 'analyze') {
        log('è§£æã‚¿ã‚¤ãƒ—ç¢ºèª: analyze');
        const { recordedData, sampleRate, noiseFloor } = data;
        
        log('å—ä¿¡ãƒ‡ãƒ¼ã‚¿ç¢ºèª', {
            dataLength: recordedData.length,
            sampleRate: sampleRate,
            noiseFloor: noiseFloor,
            duration: (recordedData.length / sampleRate).toFixed(2) + 'ç§’'
        });
        
        try {
            log('è§£æå‡¦ç†é–‹å§‹');
            const startTime = Date.now();
            
            const freqBands = [125, 250, 500, 1000, 2000, 4000];
            const rt60Results = [];
            const snrResults = [];
            const methodsUsed = [];
            const qualityLevels = [];
            
            log('å‘¨æ³¢æ•°å¸¯åŸŸå‡¦ç†é–‹å§‹', { bands: freqBands.length });
            
            for (let i = 0; i < freqBands.length; i++) {
                log(\`===== å¸¯åŸŸ \${i+1}/6 å‡¦ç†é–‹å§‹ =====\`, { freq: freqBands[i] + 'Hz' });
                
                const centerFreq = freqBands[i];
                
                const filtered = applyBandpassFilter(recordedData, sampleRate, centerFreq, centerFreq);
                
                const edc = schroederIntegration(filtered);
                
                const rtResult = calculateRT(edc, sampleRate);
                log(\`RTè¨ˆç®—å®Œäº† \${i+1}/6\`, { 
                    method: rtResult.method, 
                    value: rtResult.value,
                    quality: rtResult.quality
                });
                
                const snr = calculateSNR(filtered, noiseFloor);
                log(\`SNRè¨ˆç®—å®Œäº† \${i+1}/6\`, { snr: snr.toFixed(1) + 'dB' });
                
                rt60Results.push(rtResult.value);
                snrResults.push(snr);
                methodsUsed.push(rtResult.method);
                qualityLevels.push(rtResult.quality);
                
                log(\`===== å¸¯åŸŸ \${i+1}/6 å‡¦ç†å®Œäº† =====\`);
            }
            
            log('å…¨å¸¯åŸŸå‡¦ç†å®Œäº†');
            log('å“è³ªè©•ä¾¡é–‹å§‹');
            
            let overallQuality = 'good';
            let qualityReason = '';
            
            const minSNR = Math.min(...snrResults.filter(s => !isNaN(s)));
            log('æœ€å°SNR', { value: minSNR.toFixed(1) + 'dB' });
            
            if (minSNR < 15) {
                overallQuality = 'poor';
                qualityReason = \`S/Næ¯”ä¸è¶³ï¼ˆ\${minSNR.toFixed(1)}dB < 15dBï¼‰ã€‚ç’°å¢ƒãƒã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚é™ã‹ãªç’°å¢ƒã§å†æ¸¬å®šã—ã¦ãã ã•ã„ã€‚\`;
            }
            
            const successCount = rt60Results.filter(rt => rt !== null).length;
            log('æ¸¬å®šæˆåŠŸæ•°', { count: successCount + '/6' });
            
            if (successCount < 4) {
                overallQuality = 'poor';
                qualityReason = \`æ¸¬å®šæˆåŠŸç‡ãŒä½ã™ãã¾ã™ï¼ˆ\${successCount}/6å¸¯åŸŸï¼‰ã€‚ã‚¹ã‚¤ãƒ¼ãƒ—éŸ³é‡ã‚’ä¸Šã’ã‚‹ã‹ã€ã‚ˆã‚Šé™ã‹ãªç’°å¢ƒã§å†æ¸¬å®šã—ã¦ãã ã•ã„ã€‚\`;
            }
            
            const validRT60 = rt60Results.filter(rt => rt !== null && rt >= 0.05 && rt <= 5.0);
            if (validRT60.length < successCount) {
                overallQuality = 'poor';
                qualityReason = 'RT60å€¤ãŒç‰©ç†çš„ã«å¦¥å½“ãªç¯„å›²å¤–ã§ã™ã€‚æ¸¬å®šç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            }
            
            const methodCounts = {
                T60: methodsUsed.filter(m => m === 'T60').length,
                T30: methodsUsed.filter(m => m === 'T30').length,
                T20: methodsUsed.filter(m => m === 'T20').length,
                failed: methodsUsed.filter(m => m === 'failed').length
            };
            
            log('æ¸¬å®šæ‰‹æ³•åˆ†å¸ƒ', methodCounts);
            
            let primaryMethod = 'T30';
            if (methodCounts.T60 >= 4) primaryMethod = 'T60';
            else if (methodCounts.T20 >= 4) primaryMethod = 'T20';
            
            log('å“è³ªè©•ä¾¡å®Œäº†', { quality: overallQuality, primaryMethod: primaryMethod });
            log('çµæœé€ä¿¡ä¸­...');
            
            self.postMessage({
                type: 'result',
                rt60: rt60Results,
                snr: snrResults,
                quality: overallQuality,
                qualityReason: qualityReason,
                methods: methodsUsed,
                primaryMethod: primaryMethod,
                methodCounts: methodCounts
            });
            
            const processingTime = (Date.now() - startTime) / 1000;
            log('=== Workerå®Œäº† ===', { processingTime: processingTime.toFixed(2) + 'ç§’' });
            
        } catch (error) {
            log('âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', { 
                message: error.message,
                stack: error.stack
            });
            
            self.postMessage({
                type: 'error',
                message: 'è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message
            });
        }
    }
};
`;

// ========================================
// WorkeråˆæœŸåŒ–ï¼ˆã“ã®é–¢æ•°å…¨ä½“ã‚’ç½®ãæ›ãˆï¼‰
// ========================================
let measurementWorker = null;

function initWorker() {
    console.log('WorkeråˆæœŸåŒ–é–‹å§‹...');
    
    const blob = new Blob([workerCode], { type: 'text/javascript' });
    const workerUrl = URL.createObjectURL(blob);
    measurementWorker = new Worker(workerUrl);
    
    console.log('Workerä½œæˆå®Œäº†:', measurementWorker);
    
    measurementWorker.onmessage = function(e) {
        console.log('ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰: Workerã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡', e.data.type);
        
        const { type } = e.data;
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (type === 'debug') {
            console.log('[Worker Debug]', e.data.message, e.data.data || '');
            return;
        }
        
        // çµæœå‡¦ç†
        if (type === 'result') {
            console.log('ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰: çµæœå—ä¿¡');
            const { rt60, snr, quality, qualityReason, methods, primaryMethod, methodCounts } = e.data;
            handleMeasurementResult(rt60, snr, quality, qualityReason, methods, primaryMethod, methodCounts);
        } else if (type === 'error') {
            console.log('ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰: ã‚¨ãƒ©ãƒ¼å—ä¿¡');
            const { message } = e.data;
            handleMeasurementError(message);
        }
    };
    
    measurementWorker.onerror = function(error) {
        console.error('âŒ WorkeråˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    };
    
    console.log('Workerãƒãƒ³ãƒ‰ãƒ©è¨­å®šå®Œäº†');
}

// ========================================
// DOMContentLoaded ã§WorkeråˆæœŸåŒ–ï¼ˆè¿½åŠ ï¼‰
// ========================================
window.addEventListener('DOMContentLoaded', function() {
    console.log('=== WorkeråˆæœŸåŒ–é–‹å§‹ ===');
    initWorker();
    console.log('=== WorkeråˆæœŸåŒ–å®Œäº† ===');
});
</script>

<script>
const MEASUREMENT_CONFIG = {
    sampleRate: 48000,
    calibrationDuration: 2.5,
    sweepDuration: 5.0,
    silenceDuration: 5.0,
    totalDuration: 10.0,
    startFreq: 20,
    endFreq: 20000,
    beepFreq: 1000,
    beepDuration: 0.2,
    waitAfterBeep: 1.0,
    minSNR: 20,
    sweepGain: 0.5
};

let audioContext = null;
let mediaStream = null;
let recordedBuffer = null;
let noiseFloorLevel = 0;

async function runMeasurementSequence() {
    const statusEl = document.getElementById('measureStatus');
    const startBtn = document.getElementById('startMeasBtn');
    const recordingAlert = document.getElementById('recordingAlert');
    const warningEl = document.getElementById('remeasureWarning');
    
    startBtn.disabled = true;
    warningEl.style.display = 'none';
    
    try {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)({
                sampleRate: MEASUREMENT_CONFIG.sampleRate
            });
        }
        
        statusEl.textContent = 'ğŸ¤ ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­... é™ã‹ã«ã—ã¦ãã ã•ã„';
        statusEl.className = 'status-msg calibrating';
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        noiseFloorLevel = await measureNoiseFloor();
        
        if (noiseFloorLevel > 0.05) {
            throw new Error('ç’°å¢ƒãƒã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚é™ã‹ãªç’°å¢ƒã§æ¸¬å®šã—ã¦ãã ã•ã„ã€‚');
        }
        
        statusEl.textContent = 'â° ã¾ã‚‚ãªãæ¸¬å®šã‚’é–‹å§‹ã—ã¾ã™...';
        statusEl.className = 'status-msg calibrating';
        
        await playBeep();
        await new Promise(resolve => setTimeout(resolve, MEASUREMENT_CONFIG.waitAfterBeep * 1000));
        
        statusEl.textContent = 'ğŸ“¢ æ¸¬å®šä¸­... é™ã‹ã«ã—ã¦ãã ã•ã„';
        statusEl.className = 'status-msg analyzing';
        recordingAlert.classList.add('active');
        
        recordedBuffer = await recordSweep();
        
        recordingAlert.classList.remove('active');
        
        statusEl.textContent = 'ğŸ” è§£æä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„';
        statusEl.className = 'status-msg analyzing';
        
        const channelData = recordedBuffer.getChannelData(0);
        
        measurementWorker.postMessage({
            type: 'analyze',
            data: {
                recordedData: Array.from(channelData),
                sampleRate: MEASUREMENT_CONFIG.sampleRate,
                noiseFloor: noiseFloorLevel
            }
        });
        
    } catch (error) {
        statusEl.textContent = 'âŒ æ¸¬å®šå¤±æ•—: ' + error.message;
        statusEl.className = 'status-msg error';
        recordingAlert.classList.remove('active');
        startBtn.disabled = false;
    }
}

async function measureNoiseFloor() {
    try {
        const micDeviceId = document.getElementById('micSelect').value;
        
        if (!micDeviceId) {
            throw new Error('ãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        
        const constraints = {
            audio: {
                deviceId: micDeviceId ? { exact: micDeviceId } : undefined,
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false
            }
        };
        
        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const source = audioContext.createMediaStreamSource(mediaStream);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);
        
        const dataArray = new Float32Array(analyser.frequencyBinCount);
        const samples = [];
        
        const startTime = audioContext.currentTime;
        const duration = MEASUREMENT_CONFIG.calibrationDuration;
        
        return new Promise((resolve) => {
            const checkNoise = () => {
                analyser.getFloatTimeDomainData(dataArray);
                
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i] * dataArray[i];
                }
                const rms = Math.sqrt(sum / dataArray.length);
                samples.push(rms);
                
                if (audioContext.currentTime - startTime < duration) {
                    requestAnimationFrame(checkNoise);
                } else {
                    const avgNoise = samples.reduce((a, b) => a + b, 0) / samples.length;
                    resolve(avgNoise);
                }
            };
            checkNoise();
        });
        
    } catch (error) {
        throw new Error('ãƒã‚¤ã‚¯å…¥åŠ›ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    }
}

async function playBeep() {
    return new Promise((resolve) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = MEASUREMENT_CONFIG.beepFreq;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
        gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + MEASUREMENT_CONFIG.beepDuration);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + MEASUREMENT_CONFIG.beepDuration);
        
        oscillator.onended = () => resolve();
    });
}

async function recordSweep() {
    return new Promise(async (resolve, reject) => {
        try {
            const sweepBuffer = generateLogSweep();
            
            const totalSamples = MEASUREMENT_CONFIG.totalDuration * MEASUREMENT_CONFIG.sampleRate;
            const recordBuffer = audioContext.createBuffer(1, totalSamples, MEASUREMENT_CONFIG.sampleRate);
            
            const bufferSource = audioContext.createBufferSource();
            const mediaStreamSource = audioContext.createMediaStreamSource(mediaStream);
            const processor = audioContext.createScriptProcessor(4096, 1, 1);
            
            bufferSource.buffer = sweepBuffer;
            bufferSource.connect(audioContext.destination);
            
            let recordIndex = 0;
            const channelData = recordBuffer.getChannelData(0);
            
            processor.onaudioprocess = (e) => {
                const inputData = e.inputBuffer.getChannelData(0);
                
                for (let i = 0; i < inputData.length; i++) {
                    if (recordIndex < totalSamples) {
                        channelData[recordIndex++] = inputData[i];
                    }
                }
                
                if (recordIndex >= totalSamples) {
                    processor.disconnect();
                    mediaStreamSource.disconnect();
                    
                    mediaStream.getTracks().forEach(track => track.stop());
                    
                    resolve(recordBuffer);
                }
            };
            
            mediaStreamSource.connect(processor);
            processor.connect(audioContext.destination);
            
            bufferSource.start(audioContext.currentTime);
            
        } catch (error) {
            reject(error);
        }
    });
}

function generateLogSweep() {
    const duration = MEASUREMENT_CONFIG.sweepDuration;
    const sampleRate = MEASUREMENT_CONFIG.sampleRate;
    const length = duration * sampleRate;
    
    const buffer = audioContext.createBuffer(1, length, sampleRate);
    const channelData = buffer.getChannelData(0);
    
    const f1 = MEASUREMENT_CONFIG.startFreq;
    const f2 = MEASUREMENT_CONFIG.endFreq;
    const k = Math.exp(Math.log(f2 / f1) / duration);
    
    for (let i = 0; i < length; i++) {
        const t = i / sampleRate;
        const freq = f1 * Math.pow(k, t);
        const phase = 2 * Math.PI * f1 * (Math.pow(k, t) - 1) / Math.log(k);
        
        channelData[i] = MEASUREMENT_CONFIG.sweepGain * Math.sin(phase);
        
        if (i < sampleRate * 0.1) {
            channelData[i] *= i / (sampleRate * 0.1);
        } else if (i > length - sampleRate * 0.1) {
            channelData[i] *= (length - i) / (sampleRate * 0.1);
        }
    }
    
    return buffer;
}
</script>

<script>
function sendToGoogleForm() {
    const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSedr8Z99dcRJuV3qYRmYddUUzYGrnvrz2aU3zbFvrwVpbTreQ/viewform";
    
    const appSelect = document.getElementById('appTarget');
    const app = appSelect.options[appSelect.selectedIndex].text;
    
    const w = document.getElementById('w').value;
    const d = document.getElementById('d').value;
    const h = document.getElementById('h').value;
    const size = `${w}m Ã— ${d}m Ã— ${h}m`;
    
    const wallSelect = document.getElementById('baseWall');
    const ceilingSelect = document.getElementById('baseCeiling');
    const floorSelect = document.getElementById('baseFloor');
    
    const wallMat = wallSelect.options[wallSelect.selectedIndex].text;
    const ceilingMat = ceilingSelect.options[ceilingSelect.selectedIndex].text;
    const floorMat = floorSelect.options[floorSelect.selectedIndex].text;
    
    const base = `å£: ${wallMat}, å¤©äº•: ${ceilingMat}, åºŠ: ${floorMat}`;
    
    let productList = "";
    for (let i = 0; i < 3; i++) {
        const spec = selectedSpecs[i];
        const qty = parseInt(document.getElementById(`qty_${i}`).value) || 0;
        
        if (spec.category && spec.model && spec.thick && spec.size && qty > 0) {
            const product = SOUNDBOX_DB.products[spec.category].models[spec.model];
            productList += `ãƒ»${product.n} / ${spec.thick}mm / ${spec.size} Ã— ${qty}æš\n`;
        }
    }
    
    if (!productList) {
        productList = "é¸æŠãªã—";
    }
    
    const rtText = document.getElementById('postRT_Avg').textContent;
    
    const params = new URLSearchParams();
    params.append("usp", "pp_url");
    params.append("entry.1871431492", app);
    params.append("entry.1902994140", size);
    params.append("entry.779901469", base);
    params.append("entry.364281805", productList);
    params.append("entry.1449240528", rtText);
    
    const finalUrl = `${formUrl}?${params.toString()}`;
    window.open(finalUrl, '_blank');
}

function updateChart(rt_before, rt_after, targetRT) {
    const ctx = document.getElementById('rtChart').getContext('2d');
    
    if (chart) {
        chart.destroy();
    }
    
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: FREQS.map(f => f + 'Hz'),
            datasets: [
                {
                    label: 'ç¾çŠ¶ (Before)',
                    data: rt_before,
                    borderColor: '#8b949e',
                    backgroundColor: 'rgba(139, 148, 158, 0.05)',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: '#8b949e'
                },
                {
                    label: 'å¯¾ç­–å¾Œ (After)',
                    data: rt_after,
                    borderColor: '#39d353',
                    backgroundColor: 'rgba(57, 211, 83, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 5,
                    pointBackgroundColor: '#39d353',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                },
                {
                    label: 'ç›®æ¨™å€¤',
                    data: FREQS.map(() => targetRT),
                    borderColor: '#388bfd',
                    backgroundColor: 'rgba(56, 139, 253, 0.05)',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    fill: false,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    min: 0,
                    max: 2.5,
                    grid: {
                        color: '#30363d',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#8b949e',
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return value.toFixed(1) + 's';
                        }
                    },
                    title: {
                        display: true,
                        text: 'RT60 (sec)',
                        color: '#8b949e',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                },
                x: {
                    grid: {
                        color: '#30363d',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#8b949e',
                        font: {
                            size: 11
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#e6edf3',
                        font: {
                            size: 11
                        },
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(22, 27, 34, 0.95)',
                    titleColor: '#e6edf3',
                    bodyColor: '#e6edf3',
                    borderColor: '#30363d',
                    borderWidth: 1,
                    padding: 10,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + 's';
                        }
                    }
                }
            }
        }
    });
}
</script>

</body>
</html>
